

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://raw.githubusercontent.com/Luyoung0001/picBed/main/low.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Luyoung">
  <meta name="keywords" content="">
  
    <meta name="description" content="〇、前言本文主要完成 MIT 6.S081 实验  mmap 。开始之前，切换分支： 123$ git fetch$ git checkout mmap$ make clean  Lab: mmap (hard)Question requirements The mmap and munmap system calls allow UNIX programs to exert detailed">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.S081学习笔记（第九章）">
<meta property="og:url" content="http://blog.luliang.online/2023/12/23/MIT%206.S081%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%89/index.html">
<meta property="og:site_name" content="Luyoung">
<meta property="og:description" content="〇、前言本文主要完成 MIT 6.S081 实验  mmap 。开始之前，切换分支： 123$ git fetch$ git checkout mmap$ make clean  Lab: mmap (hard)Question requirements The mmap and munmap system calls allow UNIX programs to exert detailed">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-12-23T14:22:25.000Z">
<meta property="article:modified_time" content="2026-01-24T09:00:40.426Z">
<meta property="article:author" content="Luyoung">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="MIT 6.S081">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>MIT 6.S081学习笔记（第九章） - Luyoung</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.luliang.online","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 65vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Luyoung</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/Luyoung0001/picBed/main/1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MIT 6.S081学习笔记（第九章）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-23 22:22" pubdate>
          2023年12月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          21 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MIT 6.S081学习笔记（第九章）</h1>
            
            
              <div class="markdown-body">
                
                <span id="more"></span>

<h2 id="〇、前言"><a href="#〇、前言" class="headerlink" title="〇、前言"></a>〇、前言</h2><p>本文主要完成 <strong>MIT 6.S081</strong> 实验  <strong>mmap</strong> 。<br>开始之前，切换分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git fetch<br>$ git checkout mmap<br>$ make clean<br></code></pre></td></tr></table></figure>

<h2 id="Lab-mmap-hard"><a href="#Lab-mmap-hard" class="headerlink" title="Lab: mmap (hard)"></a>Lab: mmap (hard)</h2><h3 id="Question-requirements"><a href="#Question-requirements" class="headerlink" title="Question requirements"></a>Question requirements</h3><blockquote>
<p>The mmap and munmap system calls allow UNIX programs to exert detailed control over their address spaces. They can be used to share memory among processes, to map files into process address spaces, and as part of user-level page fault schemes such as the garbage-collection algorithms discussed in lecture. <strong>In this lab you’ll add mmap and munmap to xv6, focusing on memory-mapped files.</strong></p>
</blockquote>
<blockquote>
<p>You should implement enough mmap and munmap functionality to make the <strong>mmaptest</strong> test program work. If <strong>mmaptest</strong> doesn’t use a mmap feature, you don’t need to implement that feature.</p>
</blockquote>
<h3 id="Here-are-some-hints"><a href="#Here-are-some-hints" class="headerlink" title="Here are some hints:"></a>Here are some hints:</h3><blockquote>
<ul>
<li>Start by adding <strong>_mmaptest</strong> to <strong>UPROGS</strong>, and <strong>mmap</strong> and <strong>munmap</strong> system calls, in order to get <code>user/mmaptest.c</code> to compile.</li>
<li>Fill in the page table lazily, in response to page faults. That is, <strong>mmap</strong> should not allocate physical memory or read the file. Instead, <strong>do that in page fault handling code in (or called by) usertrap</strong>, as in the <strong>lazy page allocation lab</strong>. The reason to be lazy is to ensure <strong>that mmap of a large file is fast, and that mmap of a file larger than physical memory is possible.</strong></li>
<li>Keep track of what <strong>mmap</strong> has mapped for each process. Define a structure corresponding to the <strong>VMA</strong> (virtual memory area) described in Lecture 15, recording the <strong>address, length, permissions, file, etc</strong>. for a virtual memory range created by mmap.</li>
<li>Since the xv6 kernel doesn’t have a memory allocator in the kernel, it’s OK to declare a <strong>fixed-size array of VMAs</strong> and allocate from that array as needed. <strong>A size of 16 should be sufficient.</strong></li>
<li>Implement mmap: find an unused region in the process’s address space in which to map the file, and add a VMA to the process’s table of mapped regions. <strong>The VMA should contain a pointer to a struct file for the file being mapped</strong>; mmap should increase the file’s reference count so that the structure doesn’t disappear when the file is closed (hint: see filedup). Run mmaptest: the first mmap should succeed, <strong>but the first access to the mmap-ed memory will cause a page fault and kill mmaptest.</strong></li>
<li>Add code to cause a page-fault in a <strong>mmap-ed</strong> region to allocate a page of physical memory, read 4096 bytes of the relevant file into that page, and map it into the user address space. Read the file with <strong>readi</strong>, which takes an offset argument at which to read in the file (but you will have to lock&#x2F;unlock the inode passed to readi). Don’t forget to set the permissions correctly on the page. Run <strong>mmaptest</strong>; it should get to the first munmap.<br>Implement munmap: find the VMA for the address range and unmap the specified pages (hint: use <strong>uvmunmap</strong>). If munmap removes all pages of a previous mmap, it should decrement the reference count of the corresponding struct file. If an unmapped page has been modified and the file is mapped <strong>MAP_SHARED</strong>, write the page back to the file. Look at filewrite for inspiration.</li>
<li>Ideally your implementation would only write back <strong>MAP_SHARED</strong> pages that the program actually modified. The dirty bit (D) in the RISC-V PTE indicates whether a page has been written. However, <strong>mmaptest</strong> does not check that non-dirty pages are not written back; thus you can get away with writing pages back without looking at D bits.<br>Modify exit to unmap the process’s mapped regions as if munmap had been called. Run <strong>mmaptest</strong>; <strong>mmap_test</strong> should pass, but probably not <strong>fork_test</strong>.</li>
<li>Modify fork to ensure that the child has the same mapped regions as the parent. Don’t forget to increment the reference count for a VMA’s struct file. In the page fault handler of the child, it is OK to allocate a new physical page instead of sharing a page with the parent. The latter would be cooler, but it would require more implementation work. Run <strong>mmaptest</strong>; it should pass both <strong>mmap_test</strong> and <strong>fork_test</strong>.</li>
</ul>
</blockquote>
<h3 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h3><h4 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h4><p>我们需要先添加必要的声明。</p>
<p>在 <code>kernel/syscall.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYS_close  21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYS_mmap   22</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYS_munmap 23</span><br></code></pre></td></tr></table></figure>

<p>在 <code>kernel/syscall.c</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> uint64 <span class="hljs-title function_">sys_close</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-keyword">extern</span> uint64 <span class="hljs-title function_">sys_mmap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-keyword">extern</span> uint64 <span class="hljs-title function_">sys_munmap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br>...<br><span class="hljs-type">static</span> <span class="hljs-title function_">uint64</span> <span class="hljs-params">(*syscalls[])</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> = &#123;<br>...<br>[SYS_close]   sys_close,<br>[SYS_mmap]    sys_mmap,<br>[SYS_munmap]  sys_munmap,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在 <code>user/usys.pl</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">entry(<span class="hljs-string">&quot;uptime&quot;</span>);<br>entry(<span class="hljs-string">&quot;mmap&quot;</span>);<br>entry(<span class="hljs-string">&quot;munmap&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>在 <code>user/user.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">int</span>,<span class="hljs-type">int</span>,<span class="hljs-type">int</span>,<span class="hljs-type">int</span>,<span class="hljs-type">int</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">int</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>系统调用声明处理好后，接下来就得在内核中实现它。</p>
<p>这里涉及的操作系统基本概念是虚拟内存，<strong>mmap</strong> 用来将文件映射到内存上，<strong>munmap</strong> 将文件从某个进程的内存空间移除。</p>
<h4 id="2、代码实现"><a href="#2、代码实现" class="headerlink" title="2、代码实现"></a>2、代码实现</h4><p>为了尽量使得 <strong>map</strong> 的文件使用的地址空间不要和进程所使用的地址空间产生冲突，将 <strong>mmap</strong> 映射进来的文件 <strong>map</strong> 到尽可能高的位置，也就是刚好在 <strong>trapframe</strong> 下面。并且若有多个 <strong>mmap</strong> 的文件，则向下生长，修改<code>kernel/memlayout.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">...<br><span class="hljs-comment">//   TRAMPOLINE (the same page as in the kernel)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRAPFRAME (TRAMPOLINE - PGSIZE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAPEND TRAPFRAME</span><br></code></pre></td></tr></table></figure>

<p>接下来定义 <strong>vma</strong> 结构体，其中包含了 <strong>mmap</strong> 映射的内存区域的各种必要信息，比如开始地址、大小、所映射文件、文件内偏移以及权限等，然后在 <strong>proc</strong> 结构体末尾为每个进程加上 <strong>16</strong> 个 <strong>vma</strong> 空槽（按照 <strong>hints</strong> 中建议）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/proc.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> &#123;</span><br>  <span class="hljs-type">int</span> valid;<br>  uint64 vastart;<br>  uint64 sz;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-type">int</span> prot;<br>  <span class="hljs-type">int</span> flags;<br>  uint64 offset;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NVMA 16</span><br><br><span class="hljs-comment">// Per-process state</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> &#123;</span><br>  ...<br>  <span class="hljs-type">char</span> name[<span class="hljs-number">16</span>];               <span class="hljs-comment">// Process name (debugging)</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> <span class="hljs-title">vmas</span>[<span class="hljs-title">NVMA</span>];</span>       <span class="hljs-comment">// virtual memory areas</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>接下来在 <code>kernel/sysfile.c</code> 实现 <strong>mmap</strong> 系统调用，记得在头文件中加上<code>#include &quot;memlayout.h&quot;</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 映射文件</span><br>uint64<br><span class="hljs-title function_">sys_mmap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  uint64 addr, sz, offset;<br>  <span class="hljs-type">int</span> prot, flags, fd; <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-comment">// 获取参数</span><br>  argaddr(<span class="hljs-number">0</span>, &amp;addr);<br>  argaddr(<span class="hljs-number">1</span>, &amp;sz);<br>  argint(<span class="hljs-number">2</span>, &amp;prot);<br>  argint(<span class="hljs-number">3</span>, &amp;flags);<br>  argfd(<span class="hljs-number">4</span>, &amp;fd, &amp;f);<br>  argaddr(<span class="hljs-number">5</span>, &amp;offset);<br><br>  <span class="hljs-comment">// 安全检查</span><br>  <span class="hljs-keyword">if</span>((!f-&gt;readable &amp;&amp; (prot &amp; (PROT_READ)))<br>     || (!f-&gt;writable &amp;&amp; (prot &amp; PROT_WRITE) &amp;&amp; !(flags &amp; MAP_PRIVATE)))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  sz = PGROUNDUP(sz);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">v</span> =</span> <span class="hljs-number">0</span>;<br>  uint64 vaend = MMAPEND;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;NVMA;i++) &#123;<br>  	<span class="hljs-comment">// 寻找空槽</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">vv</span> =</span> &amp;p-&gt;vmas[i];<br>    <span class="hljs-keyword">if</span>(vv-&gt;valid == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span>(v == <span class="hljs-number">0</span>) &#123;<br>        v = &amp;p-&gt;vmas[i];<br>        v-&gt;valid = <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(vv-&gt;vastart &lt; vaend) &#123;<br>      vaend = PGROUNDDOWN(vv-&gt;vastart);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(v == <span class="hljs-number">0</span>)&#123;<br>    panic(<span class="hljs-string">&quot;mmap: no free vma&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 设置</span><br>  v-&gt;vastart = vaend - sz;<br>  v-&gt;sz = sz;<br>  v-&gt;prot = prot;<br>  v-&gt;flags = flags;<br>  v-&gt;f = f; <span class="hljs-comment">// assume f-&gt;type == FD_INODE</span><br>  v-&gt;offset = offset;<br>  <span class="hljs-comment">// 增加文件链接计数</span><br>  filedup(v-&gt;f);<br>  <span class="hljs-keyword">return</span> v-&gt;vastart;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上面的系统调用非常快，但是此时文件或许并不在内存中，访问的时候，大概率会出现<strong>segment falt</strong>，这时候我们需要再 <strong>usertrap</strong> 中进行处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/trap.c</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">usertrap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>...<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">// ok</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    uint64 va = r_stval();<br>    <span class="hljs-keyword">if</span>((r_scause() == <span class="hljs-number">13</span> || r_scause() == <span class="hljs-number">15</span>))&#123; <span class="hljs-comment">// vma 懒分配</span><br>      <span class="hljs-keyword">if</span>(!vmatrylazytouch(va)) &#123;<br>        <span class="hljs-keyword">goto</span> unexpected_scause;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      unexpected_scause:<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());<br>      p-&gt;killed = <span class="hljs-number">1</span>;<br>    &#125;<br>  &#125;<br>  ...<br>  usertrapret();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>kernel/sysfile.c</code>中实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 找到与传入的虚拟地址匹配的 VMA 结构</span><br><span class="hljs-keyword">struct</span> vma *<span class="hljs-title function_">findvma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> proc *p, uint64 va)</span> &#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;NVMA;i++) &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">vv</span> =</span> &amp;p-&gt;vmas[i];<br>    <span class="hljs-keyword">if</span>(vv-&gt;valid == <span class="hljs-number">1</span> &amp;&amp; va &gt;= vv-&gt;vastart &amp;&amp; va &lt; vv-&gt;vastart + vv-&gt;sz) &#123;<br>      <span class="hljs-keyword">return</span> vv;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 这里做的是真正的映射：将文件映射到内存中</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vmatrylazytouch</span><span class="hljs-params">(uint64 va)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-comment">// 在本进程中找</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">v</span> =</span> findvma(p, va);<br>  <span class="hljs-keyword">if</span>(v == <span class="hljs-number">0</span>) &#123;<br> 	<span class="hljs-comment">// 失败</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 分配内存</span><br>  <span class="hljs-type">void</span> *pa = kalloc();<br>  <span class="hljs-keyword">if</span>(pa == <span class="hljs-number">0</span>) &#123;<br>    panic(<span class="hljs-string">&quot;vmalazytouch: kalloc&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">0</span>, PGSIZE);<br><br>  <span class="hljs-comment">// 从硬盘中将文件读到内存</span><br>  begin_op();<br>  ilock(v-&gt;f-&gt;ip);<br>  readi(v-&gt;f-&gt;ip, <span class="hljs-number">0</span>, (uint64)pa, v-&gt;offset + PGROUNDDOWN(va - v-&gt;vastart), PGSIZE);<br>  iunlock(v-&gt;f-&gt;ip);<br>  end_op();<br><br>  <span class="hljs-comment">// set appropriate perms, then map it.</span><br>  <span class="hljs-type">int</span> perm = PTE_U;<br>  <span class="hljs-keyword">if</span>(v-&gt;prot &amp; PROT_READ)<br>    perm |= PTE_R;<br>  <span class="hljs-keyword">if</span>(v-&gt;prot &amp; PROT_WRITE)<br>    perm |= PTE_W;<br>  <span class="hljs-keyword">if</span>(v-&gt;prot &amp; PROT_EXEC)<br>    perm |= PTE_X;<br><br>  <span class="hljs-keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)pa, perm) &lt; <span class="hljs-number">0</span>) &#123;<br>    panic(<span class="hljs-string">&quot;vmalazytouch: mappages&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来实现 <code>munmap()</code> 系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/sysfile.c</span><br><br>uint64<br><span class="hljs-title function_">sys_munmap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  uint64 addr, sz;<br>  argaddr(<span class="hljs-number">0</span>, &amp;addr);<br>  argaddr(<span class="hljs-number">1</span>, &amp;sz);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">v</span> =</span> findvma(p, addr);<br>  <span class="hljs-keyword">if</span>(v == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 安全检查</span><br>  <span class="hljs-keyword">if</span>(addr &gt; v-&gt;vastart &amp;&amp; addr + sz &lt; v-&gt;vastart + v-&gt;sz) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-comment">// 对齐</span><br>  uint64 addr_aligned = addr;<br>  <span class="hljs-keyword">if</span>(addr &gt; v-&gt;vastart) &#123;<br>    addr_aligned = PGROUNDUP(addr);<br>  &#125;<br><br>  <span class="hljs-type">int</span> nunmap = sz - (addr_aligned-addr); <span class="hljs-comment">// nbytes to unmap</span><br>  <span class="hljs-keyword">if</span>(nunmap &lt; <span class="hljs-number">0</span>)<br>    nunmap = <span class="hljs-number">0</span>;<br><br>  vmaunmap(p-&gt;pagetable, addr_aligned, nunmap, v); <span class="hljs-comment">// custom memory page unmap routine for mmapped pages.</span><br><br><span class="hljs-comment">// 有重叠</span><br>  <span class="hljs-keyword">if</span>(addr &lt;= v-&gt;vastart &amp;&amp; addr + sz &gt; v-&gt;vastart) &#123;<br>    v-&gt;offset += addr + sz - v-&gt;vastart;<br>    v-&gt;vastart = addr + sz;<br>  &#125;<br>  v-&gt;sz -= sz;<br><br>  <span class="hljs-keyword">if</span>(v-&gt;sz &lt;= <span class="hljs-number">0</span>) &#123;<br>    fileclose(v-&gt;f);<br>    v-&gt;valid = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>确保要释放的范围不会在 VMA 区域中间“挖洞”，然后根据计算得到的释放起始地址和字节数，调用自定义的 <strong>vmaunmap</strong> 方法进行实际的内存释放操作。这样的设计确保了在释放内存页时对映射的精确控制，以及在需要时将数据写回磁盘。</p>
<p>将释放内存页的操作封装到 <code>vm.c</code> 中的 <strong>vmaunmap</strong> 中，这样可以<strong>更好地模块化代码</strong>。这个函数需要考虑脏位，有脏位就需要被写回。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/riscv.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_V (1L &lt;&lt; 0) <span class="hljs-comment">// valid</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_R (1L &lt;&lt; 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_W (1L &lt;&lt; 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_X (1L &lt;&lt; 3)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_U (1L <span class="hljs-string">&lt;&lt; 4) // 1 -&gt;</span> user can access</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_G (1L &lt;&lt; 5) <span class="hljs-comment">// global mapping</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_A (1L &lt;&lt; 6) <span class="hljs-comment">// accessed</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_D (1L &lt;&lt; 7) <span class="hljs-comment">// dirty</span></span><br></code></pre></td></tr></table></figure>

<p>在 <code>kernel/riscv.h</code> 中设置脏位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/vm.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;fcntl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spinlock.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sleeplock.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;file.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;proc.h&quot;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">vmaunmap</span><span class="hljs-params">(<span class="hljs-type">pagetable_t</span> pagetable, uint64 va, uint64 nbytes, <span class="hljs-keyword">struct</span> vma *v)</span><br>&#123;<br>  uint64 a;<br>  <span class="hljs-type">pte_t</span> *pte;<br><br>  <span class="hljs-keyword">for</span>(a = va; a &lt; va + nbytes; a += PGSIZE)&#123;<br>    <span class="hljs-keyword">if</span>((pte = walk(pagetable, a, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">continue</span>;<br>      <span class="hljs-comment">// 这行代码的作用是确保要取消映射的页表项是一个叶子节点，而不是中间节点或其他不应该被取消映射的节点。</span><br>    <span class="hljs-keyword">if</span>(PTE_FLAGS(*pte) == PTE_V)<br>      panic(<span class="hljs-string">&quot;sys_munmap: not a leaf&quot;</span>);<br>    <span class="hljs-keyword">if</span>(*pte &amp; PTE_V)&#123;<br>      uint64 pa = PTE2PA(*pte);<br>      <span class="hljs-comment">// 脏且共享，写回</span><br>      <span class="hljs-keyword">if</span>((*pte &amp; PTE_D) &amp;&amp; (v-&gt;flags &amp; MAP_SHARED)) &#123;<br>        begin_op();<br>        ilock(v-&gt;f-&gt;ip);<br>        uint64 aoff = a - v-&gt;vastart; <span class="hljs-comment">// offset relative to the start of memory range</span><br>        <span class="hljs-keyword">if</span>(aoff &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// if the first page is not a full 4k page</span><br>          writei(v-&gt;f-&gt;ip, <span class="hljs-number">0</span>, pa + (-aoff), v-&gt;offset, PGSIZE + aoff);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(aoff + PGSIZE &gt; v-&gt;sz)&#123;  <span class="hljs-comment">// if the last page is not a full 4k page</span><br>          writei(v-&gt;f-&gt;ip, <span class="hljs-number">0</span>, pa, v-&gt;offset + aoff, v-&gt;sz - aoff);<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// full 4k pages</span><br>          writei(v-&gt;f-&gt;ip, <span class="hljs-number">0</span>, pa, v-&gt;offset + aoff, PGSIZE);<br>        &#125;<br>        iunlock(v-&gt;f-&gt;ip);<br>        end_op();<br>      &#125;<br>      kfree((<span class="hljs-type">void</span>*)pa);<br>      *pte = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后需要做的，是在 <code>proc.c</code> 中添加处理进程 <strong>vma</strong> 的各部分代码。</p>
<ul>
<li>让 <strong>allocproc</strong> 初始化进程的时候，将 vma 槽都清空；</li>
<li><strong>freeproc</strong> 释放进程时，调用 <strong>vmaunmap</strong> 将所有 <strong>vma</strong> 的内存都释放，并在需要的时候写回磁盘；</li>
<li><strong>fork</strong> 时，拷贝父进程的所有 <strong>vma</strong>，但是不拷贝物理页（也没必要）。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/proc.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> proc*<br><span class="hljs-title function_">allocproc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-comment">// ......</span><br><br>  <span class="hljs-comment">// Clear VMAs</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;NVMA;i++) &#123;<br>    p-&gt;vmas[i].valid = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-comment">// free a proc structure and the data hanging from it,</span><br><span class="hljs-comment">// including user pages.</span><br><span class="hljs-comment">// p-&gt;lock must be held.</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">freeproc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> proc *p)</span><br>&#123;<br>  <span class="hljs-keyword">if</span>(p-&gt;trapframe)<br>    kfree((<span class="hljs-type">void</span>*)p-&gt;trapframe);<br>  p-&gt;trapframe = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++) &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">v</span> =</span> &amp;p-&gt;vmas[i];<br>    vmaunmap(p-&gt;pagetable, v-&gt;vastart, v-&gt;sz, v);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(p-&gt;pagetable)<br>    proc_freepagetable(p-&gt;pagetable, p-&gt;sz);<br>  p-&gt;pagetable = <span class="hljs-number">0</span>;<br>  p-&gt;sz = <span class="hljs-number">0</span>;<br>  p-&gt;pid = <span class="hljs-number">0</span>;<br>  p-&gt;parent = <span class="hljs-number">0</span>;<br>  p-&gt;name[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  p-&gt;chan = <span class="hljs-number">0</span>;<br>  p-&gt;killed = <span class="hljs-number">0</span>;<br>  p-&gt;xstate = <span class="hljs-number">0</span>;<br>  p-&gt;state = UNUSED;<br>&#125;<br><br><span class="hljs-comment">// Create a new process, copying the parent.</span><br><span class="hljs-comment">// Sets up child kernel stack to return as if from fork() system call.</span><br><span class="hljs-type">int</span><br><span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  ...<br>  <span class="hljs-comment">// copy vmas created by mmap.</span><br>  <span class="hljs-comment">// actual memory page as well as pte will not be copied over.</span><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NVMA; i++) &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">v</span> =</span> &amp;p-&gt;vmas[i];<br>    <span class="hljs-keyword">if</span>(v-&gt;valid) &#123;<br>      np-&gt;vmas[i] = *v;<br>      filedup(v-&gt;f);<br>    &#125;<br>  &#125;<br>...<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>由于 <strong>mmap</strong> 映射的页并不在 <strong>[0, p-&gt;sz)</strong> 范围内，所以其页表项在 <strong>fork</strong> 的时候并不会被拷贝。我们只拷贝了 <strong>vma</strong> 项到子进程，这样子进程尝试访问 <strong>mmap</strong> 页的时候，会重新触发懒加载，重新分配物理页以及建立映射。</p>
<p>最后在 <code>kernel/defs.h</code>中加入函数声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> vma*     <span class="hljs-title function_">findvma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> proc *p, uint64 va)</span>;<br><span class="hljs-type">int</span>             <span class="hljs-title function_">vmatrylazytouch</span><span class="hljs-params">(uint64 va)</span>;<br><span class="hljs-type">void</span>            <span class="hljs-title function_">vmaunmap</span><span class="hljs-params">(<span class="hljs-type">pagetable_t</span>, uint64, uint64, <span class="hljs-keyword">struct</span> vma *)</span>;<br></code></pre></td></tr></table></figure>


<p>这样，这个实验就结束了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">== Test running mmaptest ==<br>$ make qemu-gdb<br>(6.6s)<br>== Test   mmaptest: mmap f ==<br>  mmaptest: mmap f: OK<br>== Test   mmaptest: mmap private ==<br>  mmaptest: mmap private: OK<br>== Test   mmaptest: mmap read-only ==<br>  mmaptest: mmap read-only: OK<br>== Test   mmaptest: mmap <span class="hljs-built_in">read</span>/write ==<br>  mmaptest: mmap <span class="hljs-built_in">read</span>/write: OK<br>== Test   mmaptest: mmap dirty ==<br>  mmaptest: mmap dirty: OK<br>== Test   mmaptest: not-mapped unmap ==<br>  mmaptest: not-mapped unmap: OK<br>== Test   mmaptest: two files ==<br>  mmaptest: two files: OK<br>== Test   mmaptest: fork_test ==<br>  mmaptest: fork_test: OK<br>== Test usertests ==<br>$ make qemu-gdb<br>usertests: OK (102.5s)<br>== Test time ==<br>time: OK<br>Score: 140/140<br></code></pre></td></tr></table></figure>

<h2 id="总结（大模型总结）"><a href="#总结（大模型总结）" class="headerlink" title="总结（大模型总结）"></a>总结（大模型总结）</h2><p>这个实验的核心是实现对文件的内存映射，让文件内容可以直接映射到进程的地址空间中，允许对文件内容进行直接的读写操作。在实现 <strong>mmap</strong> 和 <strong>munmap</strong> 这两个系统调用时，需要注意：</p>
<ol>
<li><p><strong>Lazy Loading</strong>: 实现了懒加载，即在 <strong>mmap</strong> 中不立即分配物理内存或读取文件内容，而是在发生页错误时根据需要进行操作。这可以提高效率，特别是对于大文件或超过物理内存大小的文件映射。</p>
</li>
<li><p><strong>VMA 结构</strong>: 使用 <strong>VMA</strong>（Virtual Memory Area）结构记录映射的文件信息，包括起始地址、大小、权限、文件等信息。每个进程维护一个 <strong>VMA</strong> 数组，用于跟踪其映射的文件区域。</p>
</li>
<li><p><strong>文件写回</strong>: 在 <strong>munmap</strong> 时需要注意，如果文件是共享的（<strong>MAP_SHARED</strong>），并且有脏页（<strong>PTE_D</strong>），则需要将脏页的内容写回文件。</p>
</li>
<li><p><strong>进程 fork</strong>: 在 <strong>fork</strong> 中需要复制父进程的 <strong>VMA</strong>，但不复制物理页。子进程访问 mmap 区域时会触发页错误，执行懒加载。</p>
</li>
<li><p><strong>进程 exit</strong>: 当进程退出时，需要释放所有的 <strong>VMA</strong> 区域，并根据需要将修改过的文件页写回文件。</p>
</li>
</ol>
<p>实验的目标是确保实现 <strong>mmap</strong> 和 <strong>munmap</strong> 功能，使得测试程序 <strong>mmaptest</strong> 能够成功运行，并通过一系列测试，包括对 <strong>mmap</strong> 和 <strong>munmap</strong> 的功能、文件的读写、进程 <strong>fork</strong> 和 <strong>exit</strong> 的正确性检验等。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OS/" class="category-chain-item">OS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="print-no-link">#学习</a>
      
        <a href="/tags/%E7%AC%94%E8%AE%B0/" class="print-no-link">#笔记</a>
      
        <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="print-no-link">#操作系统</a>
      
        <a href="/tags/MIT-6-S081/" class="print-no-link">#MIT 6.S081</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MIT 6.S081学习笔记（第九章）</div>
      <div>http://blog.luliang.online/2023/12/23/MIT 6.S081学习笔记（第九章）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Luyoung</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/12/24/MIT%206.S081%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%89/" title="MIT 6.S081学习笔记（第十章）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MIT 6.S081学习笔记（第十章）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/23/Shell%20Tools%20of%20Missing%20Semester%EF%BC%88%E4%BA%8C%EF%BC%89/" title="Shell Tools of Missing Semester（二）">
                        <span class="hidden-mobile">Shell Tools of Missing Semester（二）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
