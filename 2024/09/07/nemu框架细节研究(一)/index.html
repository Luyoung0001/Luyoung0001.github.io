

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://raw.githubusercontent.com/Luyoung0001/picBed/main/low.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Luyoung">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、前言现在做到了 PA2.3后面，遇到的问题有点多，感觉总在棉花上踩。遇到了一个 bug 迟迟无法解决：用 native 且没有定义 __NATIVE_USE_KLIB__ 跑 Bad Apples 会失败，但是用 nemu 跑竟然会成功。这说明我的 klib 比 glibc 还完备吗？看了两个小时，也没看出什么。思考良久，感觉还是对项目构建过程缺乏细节上的了解，这成了学习进度上的瓶颈。于是">
<meta property="og:type" content="article">
<meta property="og:title" content="nemu框架细节研究（一）">
<meta property="og:url" content="http://blog.luliang.online/2024/09/07/nemu%E6%A1%86%E6%9E%B6%E7%BB%86%E8%8A%82%E7%A0%94%E7%A9%B6(%E4%B8%80)/index.html">
<meta property="og:site_name" content="Luyoung">
<meta property="og:description" content="一、前言现在做到了 PA2.3后面，遇到的问题有点多，感觉总在棉花上踩。遇到了一个 bug 迟迟无法解决：用 native 且没有定义 __NATIVE_USE_KLIB__ 跑 Bad Apples 会失败，但是用 nemu 跑竟然会成功。这说明我的 klib 比 glibc 还完备吗？看了两个小时，也没看出什么。思考良久，感觉还是对项目构建过程缺乏细节上的了解，这成了学习进度上的瓶颈。于是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Luyoung0001/picBed/main/native_add_test.png">
<meta property="article:published_time" content="2024-09-07T03:22:33.000Z">
<meta property="article:modified_time" content="2025-10-30T11:13:34.317Z">
<meta property="article:author" content="Luyoung">
<meta property="article:tag" content="NEMU">
<meta property="article:tag" content="PA2">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Luyoung0001/picBed/main/native_add_test.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>nemu框架细节研究（一） - Luyoung</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.luliang.online","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 65vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Luyoung</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/Luyoung0001/picBed/main/1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="nemu框架细节研究（一）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-07 11:22" pubdate>
          2024年9月7日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          66 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">nemu框架细节研究（一）</h1>
            
            
              <div class="markdown-body">
                
                <span id="more"></span>

<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>现在做到了 PA2.3后面，遇到的问题有点多，感觉总在棉花上踩。遇到了一个 bug 迟迟无法解决：用 native 且没有定义 <code>__NATIVE_USE_KLIB__</code> 跑 Bad Apples 会失败，但是用 nemu 跑竟然会成功。这说明我的 klib 比 glibc 还完备吗？看了两个小时，也没看出什么。思考良久，感觉还是对项目构建过程缺乏细节上的了解，这成了学习进度上的瓶颈。于是决定好好写几篇文章细致地研究一下这个项目的构建细节，计划花 5 天左右来做这件事。</p>
<p>本文会横向比较在 <code>/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/</code> 中两种架构 native 和 riscv32-nemu 的构建差异。</p>
<h2 id="二、native-开始的地方"><a href="#二、native-开始的地方" class="headerlink" title="二、native 开始的地方"></a>二、native 开始的地方</h2><p>在 <code>/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/</code> 下 有四个文件：</p>
<ul>
<li>tests&#x2F;</li>
<li>include&#x2F;</li>
<li>Makefile</li>
<li>.gitignore</li>
</ul>
<p><code>native</code> 的宗旨是把 <code>tests/</code>中的文件编译一个，或者多份，这取决于 <code>ALL</code> 变量的的定义情况，可以在 <code>Makefile</code> 中看到：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">...<br>ALL = <span class="hljs-variable">$(<span class="hljs-built_in">basename</span> $(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">shell</span> find tests/. -name &quot;*.c&quot;)</span>))<br>...<br></code></pre></td></tr></table></figure>

<p>如果在编译命令：<code>make ARCH=native ALL=add run</code> 中定义了，显然这个变量具有最高优先级，它会覆盖 <code>Makefile</code> 中的定义，因此 <code>ALL=add</code>。</p>
<p>接下来，仔细研究<code>Makefile</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all run gdb clean latest $(ALL)</span><br><br>RESULT = .result<br><span class="hljs-variable">$(<span class="hljs-built_in">shell</span> &gt; <span class="hljs-variable">$(RESULT)</span>)</span><br><br>COLOR_RED   = \033[1;31m<br>COLOR_GREEN = \033[1;32m<br>COLOR_NONE  = \033[0m<br><br>ALL = <span class="hljs-variable">$(<span class="hljs-built_in">basename</span> $(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">shell</span> find tests/. -name &quot;*.c&quot;)</span>))<br><br><span class="hljs-section">all: $(addprefix Makefile., <span class="hljs-variable">$(ALL)</span>)</span><br>	@echo <span class="hljs-string">&quot;test list [$(words <span class="hljs-variable">$(ALL)</span>) item(s)]:&quot;</span> <span class="hljs-variable">$(ALL)</span><br><br><span class="hljs-variable">$(ALL)</span>: %: Makefile.%<br><br><br><br><span class="hljs-section">Makefile.%: tests/%.c latest</span><br>	@/bin/echo -e <span class="hljs-string">&quot;NAME = <span class="hljs-variable">$*</span>\nSRCS = <span class="hljs-variable">$&lt;</span>\ninclude $$&#123;AM_HOME&#125;/Makefile&quot;</span> &gt; <span class="hljs-variable">$@</span><br>	@if make -s -f <span class="hljs-variable">$@</span> ARCH=<span class="hljs-variable">$(ARCH)</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>; then \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_GREEN)</span>PASS<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	<span class="hljs-keyword">else</span> \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_RED)</span>***FAIL***<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	fi<br><span class="hljs-comment">#-@rm -f Makefile.$*</span><br><br><span class="hljs-section">run: all</span><br>	@cat <span class="hljs-variable">$(RESULT)</span><br>	@rm <span class="hljs-variable">$(RESULT)</span><br><br><span class="hljs-section">gdb: all</span><br><br><span class="hljs-section">clean:</span><br>	rm -rf Makefile.* build/<br><br><span class="hljs-section">latest:</span><br><br></code></pre></td></tr></table></figure>

<p>当我执行 <code>make ARCH=native ALL=add run</code>的时候，由于目标是 <code>run</code>，因此 <code>make</code> 会找 <code>run</code> 的依赖 <code>all</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">run: all</span><br>	@cat <span class="hljs-variable">$(RESULT)</span><br>	@rm <span class="hljs-variable">$(RESULT)</span><br></code></pre></td></tr></table></figure>

<p>在 <code>Makefile</code> 被解析的时候，下面的语句就会被执行：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">RESULT = .result<br><span class="hljs-variable">$(<span class="hljs-built_in">shell</span> &gt; <span class="hljs-variable">$(RESULT)</span>)</span><br></code></pre></td></tr></table></figure>

<p>这里需要注意的是，并不是需要查找一个变量的时候，这个变量才会被赋值。正确的模型是：<code>make</code> 执行的时候，生成目标之前，整个 <code>Makefile</code> 自上而下，线性地都会被解析一遍，包括变量赋值、<code>$(shell ...)</code> 执行，就像是预处理。之后，才开始分析依赖路径，一步一步执行。</p>
<p>比如：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">A=1<br><span class="hljs-variable">$(info <span class="hljs-variable">$(A)</span>)</span><br><br>A=2<br><span class="hljs-variable">$(info <span class="hljs-variable">$(A)</span>)</span><br><br><span class="hljs-section">all:</span><br>	@echo <span class="hljs-variable">$(A)</span>+<span class="hljs-variable">$(A)</span><br><br>A=3<br><span class="hljs-variable">$(info <span class="hljs-variable">$(A)</span>)</span><br><br><br></code></pre></td></tr></table></figure>

<p>在 <code>make all</code> 的时候，它会 从上而下解析整个 <code>Makefile</code> 文件，然后才会执行 all 目标，因此它首先会打印：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ make all<br>1<br>2<br>3<br>3+3<br></code></pre></td></tr></table></figure>

<p>搞清楚这些之后，继续研究这个<code>Makefile</code>。</p>
<p>显然，这个文件没有其它的解析的东西了(<code>ALL</code> 已经通过 <code>make</code> 参数传进来了，它具有最高优先级，会覆盖 本文件的<code>ALL</code>)。这下开始构建目标<code>run</code>:</p>
<ul>
<li><code>run</code>的依赖是 <code>all</code></li>
<li>接着构建 <code>all</code>,<code>all</code>的依赖是 <code>$(addprefix Makefile., $(ALL))</code>，也就是<code>Makefile.add</code>:</li>
<li><code>Makefile.add</code>的依赖为：<code>tests/add.c latest</code>；</li>
<li><code>tests/add.c latest</code> 在本地存在；因此开始构建<code>Makefile.add</code>：</li>
</ul>
<p><code>@/bin/echo -e &quot;NAME = $*\nSRCS = $&lt;\ninclude $$&#123;AM_HOME&#125;/Makefile&quot; &gt; $@</code> 的含义是将<code>NAME = $*\nSRCS = $&lt;\ninclude $$&#123;AM_HOME&#125;/Makefile</code> 创建到目标 <code>Makefile.add</code>，这显然就生成了一个文件：<code>Makefile.add</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME = add<br>SRCS = tests/add.c<br><span class="hljs-keyword">include</span> /home/luyoung/ysyx-workbench/abstract-machine/Makefile<br><br></code></pre></td></tr></table></figure>

<p>接着执行剩下命令：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">@if make -s -f <span class="hljs-variable">$@</span> ARCH=<span class="hljs-variable">$(ARCH)</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>; then \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_GREEN)</span>PASS<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	<span class="hljs-keyword">else</span> \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_RED)</span>***FAIL***<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	fi<br></code></pre></td></tr></table></figure>

<p>含义是目标（-f） <code>Makefile</code> 为 <code>Makefile.add</code>，相当于对在 <code>Makefile.add</code> 执行 <code>make ARCH=native run</code>。$(MAKECMDGOALS)这个参数是 make 的内建变量，指得是目标 <code>run</code>。</p>
<p>接着就来到了<code>Makefile.add</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME = add<br>SRCS = tests/add.c<br><span class="hljs-keyword">include</span> /home/luyoung/ysyx-workbench/abstract-machine/Makefile<br><br></code></pre></td></tr></table></figure>

<p>这个文件包含了 <code>/home/luyoung/ysyx-workbench/abstract-machine/Makefile</code> ，也就是这个文件：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Makefile for AbstractMachine Kernels and Libraries</span><br><br><span class="hljs-comment">### *Get a more readable version of this Makefile* by `make html` (requires python-markdown)</span><br><span class="hljs-section">html:</span><br>	cat Makefile | sed &#x27;s/^\([^<span class="hljs-comment">#]\)/    \1/g&#x27; | markdown_py &gt; Makefile.html</span><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: html</span><br><br><span class="hljs-comment">## 1. Basic Setup and Checks</span><br><br><span class="hljs-comment">### Default to create a bare-metal kernel image</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(MAKECMDGOALS)</span>,)<br>  MAKECMDGOALS  = image<br>  .DEFAULT_GOAL = image<br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Override checks when `make clean/clean-all/html`</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">findstring</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>,clean|clean-all|html)</span>,)<br><br><span class="hljs-comment">### Print build info message</span><br><span class="hljs-variable">$(info # Building <span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(MAKECMDGOALS)</span> [<span class="hljs-variable">$(ARCH)</span>])</span><br><br><span class="hljs-comment">### Check: environment variable `$AM_HOME` looks sane</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> <span class="hljs-variable">$(AM_HOME)</span>/am/include/am.h)</span>,)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> $$AM_HOME must be an AbstractMachine repo)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Check: environment variable `$ARCH` must be in the supported list</span><br>ARCHS = <span class="hljs-variable">$(<span class="hljs-built_in">basename</span> $(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">shell</span> ls <span class="hljs-variable">$(AM_HOME)</span>/scripts/*.mk)</span>))<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">filter</span> <span class="hljs-variable">$(ARCHS)</span>, <span class="hljs-variable">$(ARCH)</span>)</span>, )<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Expected $$ARCH in &#123;<span class="hljs-variable">$(ARCHS)</span>&#125;, Got &quot;<span class="hljs-variable">$(ARCH)</span>&quot;)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Extract instruction set architecture (`ISA`) and platform from `$ARCH`. Example: `ARCH=x86_64-qemu -&gt; ISA=x86_64; PLATFORM=qemu`</span><br>ARCH_SPLIT = <span class="hljs-variable">$(<span class="hljs-built_in">subst</span> -, ,<span class="hljs-variable">$(ARCH)</span>)</span><br>ISA        = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 1,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br>PLATFORM   = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 2,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br><br><span class="hljs-comment">### Check if there is something to build</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">flavor</span> SRCS)</span>, undefined)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Nothing to build)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Checks end here</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">## 2. General Compilation Targets</span><br><br><span class="hljs-comment">### Create the destination directory (`build/$ARCH`)</span><br>WORK_DIR  = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br>DST_DIR   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(ARCH)</span><br><span class="hljs-variable">$(<span class="hljs-built_in">shell</span> mkdir -p <span class="hljs-variable">$(DST_DIR)</span>)</span><br><br><span class="hljs-comment">### Compilation targets (a binary image or archive)</span><br>IMAGE_REL = build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span><br>IMAGE     = <span class="hljs-variable">$(<span class="hljs-built_in">abspath</span> <span class="hljs-variable">$(IMAGE_REL)</span>)</span><br>ARCHIVE   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span>.a<br><br><span class="hljs-comment">### Collect the files to be linked: object files (`.o`) and libraries (`.a`)</span><br>OBJS      = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(DST_DIR)</span>/, $(<span class="hljs-built_in">addsuffix</span> .o, $(<span class="hljs-built_in">basename</span> <span class="hljs-variable">$(SRCS)</span>)</span>))<br>LIBS     := <span class="hljs-variable">$(<span class="hljs-built_in">sort</span> <span class="hljs-variable">$(LIBS)</span> am klib)</span> <span class="hljs-comment"># lazy evaluation (&quot;=&quot;) causes infinite recursions</span><br>LINKAGE   = <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> -<span class="hljs-variable">$(ARCH)</span>.a, $(<span class="hljs-built_in">join</span> $(<span class="hljs-built_in">addsuffix</span> /build/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>),  <span class="hljs-variable">$(LIBS)</span> ))<br><br><span class="hljs-comment">## 3. General Compilation Flags</span><br><br><span class="hljs-comment">### (Cross) compilers, e.g., mips-linux-gnu-g++</span><br>AS        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CC        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CXX       = <span class="hljs-variable">$(CROSS_COMPILE)</span>g++<br>LD        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ld<br>AR        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ar<br>OBJDUMP   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objdump<br>OBJCOPY   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objcopy<br>READELF   = <span class="hljs-variable">$(CROSS_COMPILE)</span>readelf<br><br><br><br><span class="hljs-comment">### Compilation flags</span><br>INC_PATH += <span class="hljs-variable">$(WORK_DIR)</span>/<span class="hljs-keyword">include</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> /include/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>)<br><br>INCFLAGS += <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> -I, <span class="hljs-variable">$(INC_PATH)</span>)</span><br><br>ARCH_H := arch/<span class="hljs-variable">$(ARCH)</span>.h<br>CFLAGS   += -O2 -MMD -Wall -Werror <span class="hljs-variable">$(INCFLAGS)</span> \<br>            -D__ISA__=\<span class="hljs-string">&quot;<span class="hljs-variable">$(ISA)\&quot;</span> -D__ISA_$(shell echo <span class="hljs-variable">$(ISA)</span> | tr a-z A-Z)__ \</span><br><span class="hljs-string">            -D__ARCH__=<span class="hljs-variable">$(ARCH)</span> -D__ARCH_$(shell echo <span class="hljs-variable">$(ARCH)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -D__PLATFORM__=<span class="hljs-variable">$(PLATFORM)</span> -D__PLATFORM_$(shell echo <span class="hljs-variable">$(PLATFORM)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -DARCH_H=\&quot;<span class="hljs-variable">$(ARCH_H)\&quot;</span> \</span><br><span class="hljs-string">            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \</span><br><span class="hljs-string">            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden</span><br><span class="hljs-string">CXXFLAGS +=  <span class="hljs-variable">$(CFLAGS)</span> -ffreestanding -fno-rtti -fno-exceptions</span><br><span class="hljs-string">ASFLAGS  += -MMD <span class="hljs-variable">$(INCFLAGS)</span></span><br><span class="hljs-string">LDFLAGS  += -z noexecstack</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 4. Arch-Specific Configurations</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)</span><br><span class="hljs-string">-include <span class="hljs-variable">$(AM_HOME)</span>/scripts/<span class="hljs-variable">$(ARCH)</span>.mk</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Fall back to native gcc/binutils if there is no cross compiler</span><br><span class="hljs-string">ifeq ($(wildcard $(shell which <span class="hljs-variable">$(CC)</span>)),)</span><br><span class="hljs-string">  $(info #  <span class="hljs-variable">$(CC)</span> not found; fall back to default gcc and binutils)</span><br><span class="hljs-string">  CROSS_COMPILE :=</span><br><span class="hljs-string">endif</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 5. Compilation Rules</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.c` -&gt; `.o` (gcc)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.c</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.cc` -&gt; `.o` (g++)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cc</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.cpp` -&gt; `.o` (g++)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cpp</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.S` -&gt; `.o` (gcc, which preprocesses and calls as)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.S</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + AS <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(AS)</span> <span class="hljs-variable">$(ASFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (recursive make): build a dependent library (am, klib, ...)</span><br><span class="hljs-string"><span class="hljs-variable">$(LIBS)</span>: %:</span><br><span class="hljs-string">	@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$(AM_HOME)</span>/<span class="hljs-variable">$*</span> archive</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (link): objects (`*.o`) and libraries (`*.a`) -&gt; `IMAGE.elf`, the final ELF binary to be packed into image (ld)</span><br><span class="hljs-string"><span class="hljs-variable">$(IMAGE)</span>.elf: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string">	@echo + LD &quot;</span>-&gt;<span class="hljs-string">&quot; <span class="hljs-variable">$(IMAGE_REL)</span>.elf</span><br><span class="hljs-string">	@<span class="hljs-variable">$(LD)</span> <span class="hljs-variable">$(LDFLAGS)</span> -o <span class="hljs-variable">$(IMAGE)</span>.elf --start-group <span class="hljs-variable">$(LINKAGE)</span> --end-group</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (archive): objects (`*.o`) -&gt; `ARCHIVE.a` (ar)</span><br><span class="hljs-string"><span class="hljs-variable">$(ARCHIVE)</span>: <span class="hljs-variable">$(OBJS)</span></span><br><span class="hljs-string">	@echo + AR &quot;</span>-&gt;<span class="hljs-string">&quot; $(shell realpath <span class="hljs-variable">$@</span> --relative-to .)</span><br><span class="hljs-string">	@<span class="hljs-variable">$(AR)</span> rcs <span class="hljs-variable">$(ARCHIVE)</span> <span class="hljs-variable">$(OBJS)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (`#include` dependencies): paste in `.d` files generated by gcc on `-MMD`</span><br><span class="hljs-string">-include $(addprefix <span class="hljs-variable">$(DST_DIR)</span>/, $(addsuffix .d, $(basename <span class="hljs-variable">$(SRCS)</span>)))</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 6. Miscellaneous</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Build order control</span><br><span class="hljs-string">image: image-dep</span><br><span class="hljs-string">archive: <span class="hljs-variable">$(ARCHIVE)</span></span><br><span class="hljs-string">image-dep: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string">	@echo \# Creating image [<span class="hljs-variable">$(ARCH)</span>]</span><br><span class="hljs-string">.PHONY: image image-dep archive run <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Clean a single project (remove `build/`)</span><br><span class="hljs-string">clean:</span><br><span class="hljs-string">	rm -rf Makefile.html <span class="hljs-variable">$(WORK_DIR)</span>/build/</span><br><span class="hljs-string">.PHONY: clean</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Clean all sub-projects within depth 2 (and ignore errors)</span><br><span class="hljs-string">CLEAN_ALL = $(dir $(shell find . -mindepth 2 -name Makefile))</span><br><span class="hljs-string">clean-all: <span class="hljs-variable">$(CLEAN_ALL)</span> clean</span><br><span class="hljs-string"><span class="hljs-variable">$(CLEAN_ALL)</span>:</span><br><span class="hljs-string">	-@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$@</span> clean</span><br><span class="hljs-string">.PHONY: clean-all <span class="hljs-variable">$(CLEAN_ALL)</span></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>


<p>这个文件太长，而且里面还包含了很多的 其它可包含文件，因此以下分析按照<code>文件解析</code>、<code>目标构建</code>分两步。</p>
<h3 id="1-文件包含"><a href="#1-文件包含" class="headerlink" title="1. 文件包含"></a>1. 文件包含</h3><p>上面的文件包含了：</p>
<ul>
<li><code>-include $(AM_HOME)/scripts/$(ARCH).mk</code></li>
<li><code>-include $(addprefix $(DST_DIR)/, $(addsuffix .d, $(basename $(SRCS))))</code></li>
</ul>
<p>由于 <code>ARCH=native</code>，因此它会包含: <code>/home/luyoung/ysyx-workbench/abstract-machine/scripts/native.mk</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">AM_SRCS := native/trm.c \<br>           native/ioe.c \<br>           native/cte.c \<br>           native/trap.S \<br>           native/vme.c \<br>           native/mpe.c \<br>           native/platform.c \<br>           native/ioe/input.c \<br>           native/ioe/timer.c \<br>           native/ioe/gpu.c \<br>           native/ioe/uart.c \<br>           native/ioe/audio.c \<br>           native/ioe/disk.c \<br><br>CFLAGS  += -fpie<br>ASFLAGS += -fpie -pie<br>comma = ,<br>LDFLAGS_CXX = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> -Wl<span class="hljs-variable">$(comma)</span>, <span class="hljs-variable">$(LDFLAGS)</span>)</span><br><br><span class="hljs-section">image:</span><br>	@echo + LD <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(IMAGE_REL)</span><br>	@g++ -pie -o <span class="hljs-variable">$(IMAGE)</span> -Wl,--whole-archive <span class="hljs-variable">$(LINKAGE)</span> -Wl,-no-whole-archive <span class="hljs-variable">$(LDFLAGS_CXX)</span> -lSDL2 -ldl<br><br><span class="hljs-section">run: image</span><br>	<span class="hljs-variable">$(IMAGE)</span><br><br><span class="hljs-section">gdb: image</span><br>	gdb -ex <span class="hljs-string">&quot;handle SIGUSR1 SIGUSR2 SIGSEGV noprint nostop&quot;</span> <span class="hljs-variable">$(IMAGE)</span><br></code></pre></td></tr></table></figure>

<p>第二个文件为：<code>/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/tests/add.d</code>，这个文件由编译命令 <code>gcc on</code> <code>-MMD</code> 生成，也是一个可包含文件，他就相当于依赖：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/tests/add.o: \</span><br> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/tests/add.c \<br> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/<span class="hljs-keyword">include</span>/trap.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/am.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/arch/native.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/amdev.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/klib/<span class="hljs-keyword">include</span>/klib.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/klib/<span class="hljs-keyword">include</span>/klib-macros.h<br><br></code></pre></td></tr></table></figure>

<p>之后整个文件就变成了如下的样子：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME = add<br>SRCS = tests/add.c<br><span class="hljs-comment">#include /home/luyoung/ysyx-workbench/abstract-machine/Makefile</span><br><br><span class="hljs-comment"># Makefile for AbstractMachine Kernels and Libraries</span><br><br><span class="hljs-comment">### *Get a more readable version of this Makefile* by `make html` (requires python-markdown)</span><br><span class="hljs-section">html:</span><br>	cat Makefile | sed &#x27;s/^\([^<span class="hljs-comment">#]\)/    \1/g&#x27; | markdown_py &gt; Makefile.html</span><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: html</span><br><br><span class="hljs-comment">## 1. Basic Setup and Checks</span><br><br><span class="hljs-comment">### Default to create a bare-metal kernel image</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(MAKECMDGOALS)</span>,)<br>  MAKECMDGOALS  = image<br>  .DEFAULT_GOAL = image<br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Override checks when `make clean/clean-all/html`</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">findstring</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>,clean|clean-all|html)</span>,)<br><br><span class="hljs-comment">### Print build info message</span><br><span class="hljs-variable">$(info # Building <span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(MAKECMDGOALS)</span> [<span class="hljs-variable">$(ARCH)</span>])</span><br><br><span class="hljs-comment">### Check: environment variable `$AM_HOME` looks sane</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> <span class="hljs-variable">$(AM_HOME)</span>/am/include/am.h)</span>,)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> $$AM_HOME must be an AbstractMachine repo)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Check: environment variable `$ARCH` must be in the supported list</span><br>ARCHS = <span class="hljs-variable">$(<span class="hljs-built_in">basename</span> $(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">shell</span> ls <span class="hljs-variable">$(AM_HOME)</span>/scripts/*.mk)</span>))<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">filter</span> <span class="hljs-variable">$(ARCHS)</span>, <span class="hljs-variable">$(ARCH)</span>)</span>, )<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Expected $$ARCH in &#123;<span class="hljs-variable">$(ARCHS)</span>&#125;, Got &quot;<span class="hljs-variable">$(ARCH)</span>&quot;)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Extract instruction set architecture (`ISA`) and platform from `$ARCH`. Example: `ARCH=x86_64-qemu -&gt; ISA=x86_64; PLATFORM=qemu`</span><br>ARCH_SPLIT = <span class="hljs-variable">$(<span class="hljs-built_in">subst</span> -, ,<span class="hljs-variable">$(ARCH)</span>)</span><br>ISA        = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 1,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br>PLATFORM   = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 2,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br><br><span class="hljs-comment">### Check if there is something to build</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">flavor</span> SRCS)</span>, undefined)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Nothing to build)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Checks end here</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">## 2. General Compilation Targets</span><br><br><span class="hljs-comment">### Create the destination directory (`build/$ARCH`)</span><br>WORK_DIR  = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br>DST_DIR   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(ARCH)</span><br><span class="hljs-variable">$(<span class="hljs-built_in">shell</span> mkdir -p <span class="hljs-variable">$(DST_DIR)</span>)</span><br><br><span class="hljs-comment">### Compilation targets (a binary image or archive)</span><br>IMAGE_REL = build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span><br>IMAGE     = <span class="hljs-variable">$(<span class="hljs-built_in">abspath</span> <span class="hljs-variable">$(IMAGE_REL)</span>)</span><br>ARCHIVE   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span>.a<br><br><span class="hljs-comment">### Collect the files to be linked: object files (`.o`) and libraries (`.a`)</span><br>OBJS      = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(DST_DIR)</span>/, $(<span class="hljs-built_in">addsuffix</span> .o, $(<span class="hljs-built_in">basename</span> <span class="hljs-variable">$(SRCS)</span>)</span>))<br>LIBS     := <span class="hljs-variable">$(<span class="hljs-built_in">sort</span> <span class="hljs-variable">$(LIBS)</span> am klib)</span> <span class="hljs-comment"># lazy evaluation (&quot;=&quot;) causes infinite recursions</span><br>LINKAGE   = <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> -<span class="hljs-variable">$(ARCH)</span>.a, $(<span class="hljs-built_in">join</span> $(<span class="hljs-built_in">addsuffix</span> /build/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>),  <span class="hljs-variable">$(LIBS)</span> ))<br><br><span class="hljs-comment">## 3. General Compilation Flags</span><br><br><span class="hljs-comment">### (Cross) compilers, e.g., mips-linux-gnu-g++</span><br>AS        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CC        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CXX       = <span class="hljs-variable">$(CROSS_COMPILE)</span>g++<br>LD        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ld<br>AR        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ar<br>OBJDUMP   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objdump<br>OBJCOPY   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objcopy<br>READELF   = <span class="hljs-variable">$(CROSS_COMPILE)</span>readelf<br><br><br><br><span class="hljs-comment">### Compilation flags</span><br>INC_PATH += <span class="hljs-variable">$(WORK_DIR)</span>/<span class="hljs-keyword">include</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> /include/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>)<br><br>INCFLAGS += <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> -I, <span class="hljs-variable">$(INC_PATH)</span>)</span><br><br>ARCH_H := arch/<span class="hljs-variable">$(ARCH)</span>.h<br>CFLAGS   += -O2 -MMD -Wall -Werror <span class="hljs-variable">$(INCFLAGS)</span> \<br>            -D__ISA__=\<span class="hljs-string">&quot;<span class="hljs-variable">$(ISA)\&quot;</span> -D__ISA_$(shell echo <span class="hljs-variable">$(ISA)</span> | tr a-z A-Z)__ \</span><br><span class="hljs-string">            -D__ARCH__=<span class="hljs-variable">$(ARCH)</span> -D__ARCH_$(shell echo <span class="hljs-variable">$(ARCH)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -D__PLATFORM__=<span class="hljs-variable">$(PLATFORM)</span> -D__PLATFORM_$(shell echo <span class="hljs-variable">$(PLATFORM)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -DARCH_H=\&quot;<span class="hljs-variable">$(ARCH_H)\&quot;</span> \</span><br><span class="hljs-string">            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \</span><br><span class="hljs-string">            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden</span><br><span class="hljs-string">CXXFLAGS +=  <span class="hljs-variable">$(CFLAGS)</span> -ffreestanding -fno-rtti -fno-exceptions</span><br><span class="hljs-string">ASFLAGS  += -MMD <span class="hljs-variable">$(INCFLAGS)</span></span><br><span class="hljs-string">LDFLAGS  += -z noexecstack</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 4. Arch-Specific Configurations</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)</span><br><span class="hljs-string"># -include <span class="hljs-variable">$(AM_HOME)</span>/scripts/<span class="hljs-variable">$(ARCH)</span>.mk</span><br><span class="hljs-string">AM_SRCS := native/trm.c \</span><br><span class="hljs-string">           native/ioe.c \</span><br><span class="hljs-string">           native/cte.c \</span><br><span class="hljs-string">           native/trap.S \</span><br><span class="hljs-string">           native/vme.c \</span><br><span class="hljs-string">           native/mpe.c \</span><br><span class="hljs-string">           native/platform.c \</span><br><span class="hljs-string">           native/ioe/input.c \</span><br><span class="hljs-string">           native/ioe/timer.c \</span><br><span class="hljs-string">           native/ioe/gpu.c \</span><br><span class="hljs-string">           native/ioe/uart.c \</span><br><span class="hljs-string">           native/ioe/audio.c \</span><br><span class="hljs-string">           native/ioe/disk.c \</span><br><span class="hljs-string"></span><br><span class="hljs-string">CFLAGS  += -fpie</span><br><span class="hljs-string">ASFLAGS += -fpie -pie</span><br><span class="hljs-string">comma = ,</span><br><span class="hljs-string">LDFLAGS_CXX = $(addprefix -Wl<span class="hljs-variable">$(comma)</span>, <span class="hljs-variable">$(LDFLAGS)</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">image:</span><br><span class="hljs-string">	@echo + LD &quot;</span>-&gt;<span class="hljs-string">&quot; <span class="hljs-variable">$(IMAGE_REL)</span></span><br><span class="hljs-string">	@g++ -pie -o <span class="hljs-variable">$(IMAGE)</span> -Wl,--whole-archive <span class="hljs-variable">$(LINKAGE)</span> -Wl,-no-whole-archive <span class="hljs-variable">$(LDFLAGS_CXX)</span> -lSDL2 -ldl</span><br><span class="hljs-string"></span><br><span class="hljs-string">run: image</span><br><span class="hljs-string">	<span class="hljs-variable">$(IMAGE)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">gdb: image</span><br><span class="hljs-string">	gdb -ex &quot;</span>handle SIGUSR1 SIGUSR2 SIGSEGV noprint nostop<span class="hljs-string">&quot; <span class="hljs-variable">$(IMAGE)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Fall back to native gcc/binutils if there is no cross compiler</span><br><span class="hljs-string">ifeq ($(wildcard $(shell which <span class="hljs-variable">$(CC)</span>)),)</span><br><span class="hljs-string">  $(info #  <span class="hljs-variable">$(CC)</span> not found; fall back to default gcc and binutils)</span><br><span class="hljs-string">  CROSS_COMPILE :=</span><br><span class="hljs-string">endif</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 5. Compilation Rules</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.c` -&gt; `.o` (gcc)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.c</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.cc` -&gt; `.o` (g++)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cc</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.cpp` -&gt; `.o` (g++)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cpp</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (compile): a single `.S` -&gt; `.o` (gcc, which preprocesses and calls as)</span><br><span class="hljs-string"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.S</span><br><span class="hljs-string">	@mkdir -p $(dir <span class="hljs-variable">$@</span>) &amp;&amp; echo + AS <span class="hljs-variable">$&lt;</span></span><br><span class="hljs-string">	@<span class="hljs-variable">$(AS)</span> <span class="hljs-variable">$(ASFLAGS)</span> -c -o <span class="hljs-variable">$@</span> $(realpath <span class="hljs-variable">$&lt;</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (recursive make): build a dependent library (am, klib, ...)</span><br><span class="hljs-string"><span class="hljs-variable">$(LIBS)</span>: %:</span><br><span class="hljs-string">	@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$(AM_HOME)</span>/<span class="hljs-variable">$*</span> archive</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (link): objects (`*.o`) and libraries (`*.a`) -&gt; `IMAGE.elf`, the final ELF binary to be packed into image (ld)</span><br><span class="hljs-string"><span class="hljs-variable">$(IMAGE)</span>.elf: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string">	@echo + LD &quot;</span>-&gt;<span class="hljs-string">&quot; <span class="hljs-variable">$(IMAGE_REL)</span>.elf</span><br><span class="hljs-string">	@<span class="hljs-variable">$(LD)</span> <span class="hljs-variable">$(LDFLAGS)</span> -o <span class="hljs-variable">$(IMAGE)</span>.elf --start-group <span class="hljs-variable">$(LINKAGE)</span> --end-group</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (archive): objects (`*.o`) -&gt; `ARCHIVE.a` (ar)</span><br><span class="hljs-string"><span class="hljs-variable">$(ARCHIVE)</span>: <span class="hljs-variable">$(OBJS)</span></span><br><span class="hljs-string">	@echo + AR &quot;</span>-&gt;<span class="hljs-string">&quot; $(shell realpath <span class="hljs-variable">$@</span> --relative-to .)</span><br><span class="hljs-string">	@<span class="hljs-variable">$(AR)</span> rcs <span class="hljs-variable">$(ARCHIVE)</span> <span class="hljs-variable">$(OBJS)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Rule (`#include` dependencies): paste in `.d` files generated by gcc on `-MMD`</span><br><span class="hljs-string">#-include $(addprefix <span class="hljs-variable">$(DST_DIR)</span>/, $(addsuffix .d, $(basename <span class="hljs-variable">$(SRCS)</span>)))</span><br><span class="hljs-string"></span><br><span class="hljs-string">/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/tests/add.o: \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/tests/add.c \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include/trap.h \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/abstract-machine/am/include/am.h \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/abstract-machine/am/include/arch/native.h \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/abstract-machine/am/include/amdev.h \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/abstract-machine/klib/include/klib.h \</span><br><span class="hljs-string"> /home/luyoung/ysyx-workbench/abstract-machine/klib/include/klib-macros.h</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 6. Miscellaneous</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Build order control</span><br><span class="hljs-string">image: image-dep</span><br><span class="hljs-string">archive: <span class="hljs-variable">$(ARCHIVE)</span></span><br><span class="hljs-string">image-dep: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string">	@echo \# Creating image [<span class="hljs-variable">$(ARCH)</span>]</span><br><span class="hljs-string">.PHONY: image image-dep archive run <span class="hljs-variable">$(LIBS)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Clean a single project (remove `build/`)</span><br><span class="hljs-string">clean:</span><br><span class="hljs-string">	rm -rf Makefile.html <span class="hljs-variable">$(WORK_DIR)</span>/build/</span><br><span class="hljs-string">.PHONY: clean</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Clean all sub-projects within depth 2 (and ignore errors)</span><br><span class="hljs-string">CLEAN_ALL = $(dir $(shell find . -mindepth 2 -name Makefile))</span><br><span class="hljs-string">clean-all: <span class="hljs-variable">$(CLEAN_ALL)</span> clean</span><br><span class="hljs-string"><span class="hljs-variable">$(CLEAN_ALL)</span>:</span><br><span class="hljs-string">	-@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$@</span> clean</span><br><span class="hljs-string">.PHONY: clean-all <span class="hljs-variable">$(CLEAN_ALL)</span></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<h3 id="2-文件解析"><a href="#2-文件解析" class="headerlink" title="2. 文件解析"></a>2. 文件解析</h3><p>首先自上而下解析文件。</p>
<ul>
<li><p><code>NAME</code> &#x3D; <code>add</code></p>
</li>
<li><p><code>SRCS</code> &#x3D; <code>test/add.c</code></p>
</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><br><span class="hljs-comment"># 判断目标是否为空，如果为空，将目标定为 image, 默认目标也定为 image</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(MAKECMDGOALS)</span>,)<br>  MAKECMDGOALS  = image<br>  .DEFAULT_GOAL = image<br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment"># 做一些安全检查</span><br><span class="hljs-comment">### Override checks when `make clean/clean-all/html`</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">findstring</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>,clean|clean-all|html)</span>,)<br><br><span class="hljs-comment">### Print build info message</span><br><span class="hljs-variable">$(info # Building <span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(MAKECMDGOALS)</span> [<span class="hljs-variable">$(ARCH)</span>])</span><br><br><span class="hljs-comment">### Check: environment variable `$AM_HOME` looks sane</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> <span class="hljs-variable">$(AM_HOME)</span>/am/include/am.h)</span>,)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> $$AM_HOME must be an AbstractMachine repo)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Check: environment variable `$ARCH` must be in the supported list</span><br>ARCHS = <span class="hljs-variable">$(<span class="hljs-built_in">basename</span> $(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">shell</span> ls <span class="hljs-variable">$(AM_HOME)</span>/scripts/*.mk)</span>))<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">filter</span> <span class="hljs-variable">$(ARCHS)</span>, <span class="hljs-variable">$(ARCH)</span>)</span>, )<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Expected $$ARCH in &#123;<span class="hljs-variable">$(ARCHS)</span>&#125;, Got &quot;<span class="hljs-variable">$(ARCH)</span>&quot;)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Extract instruction set architecture (`ISA`) and platform from `$ARCH`. Example: `ARCH=x86_64-qemu -&gt; ISA=x86_64; PLATFORM=qemu`</span><br><br><span class="hljs-comment"># 这里就会解析传入的 native，ARCH=native</span><br><span class="hljs-comment"># 解析完后就是 ARCH_SPLIT=native</span><br><span class="hljs-comment"># ISA=native</span><br><span class="hljs-comment"># PLATFORM= (为空)</span><br>ARCH_SPLIT = <span class="hljs-variable">$(<span class="hljs-built_in">subst</span> -, ,<span class="hljs-variable">$(ARCH)</span>)</span><br>ISA        = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 1,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br>PLATFORM   = <span class="hljs-variable">$(<span class="hljs-built_in">word</span> 2,<span class="hljs-variable">$(ARCH_SPLIT)</span>)</span><br><br><span class="hljs-comment">### Check if there is something to build</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">flavor</span> SRCS)</span>, undefined)<br>  <span class="hljs-variable">$(<span class="hljs-built_in">error</span> Nothing to build)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">### Checks end here</span><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure>

<p>这里继续解析，需要注意的是，shell pwd 是包含别的文件的目录，这里Makefile.add 包含了别的文件，因此 pwd 的结果是：<code>/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests</code>。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment">## 2. General Compilation Targets</span><br><br><span class="hljs-comment">### Create the destination directory (`build/$ARCH`)</span><br><br><span class="hljs-comment"># WORK_DIR  =/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests</span><br>WORK_DIR  = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br><br><span class="hljs-comment"># DST_DIR = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native</span><br>DST_DIR   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(ARCH)</span><br><br><span class="hljs-comment"># 创建目录/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native，-p 参数确保父目录存在，如果不存在它会自动创建；若存在就忽略</span><br><span class="hljs-variable">$(<span class="hljs-built_in">shell</span> mkdir -p <span class="hljs-variable">$(DST_DIR)</span>)</span><br><br><span class="hljs-comment">### Compilation targets (a binary image or archive)</span><br><br><span class="hljs-comment"># IMAGE_REL = build/add-native</span><br>IMAGE_REL = build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span><br><br><span class="hljs-comment"># IMAGE = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/add-native</span><br>IMAGE     = <span class="hljs-variable">$(<span class="hljs-built_in">abspath</span> <span class="hljs-variable">$(IMAGE_REL)</span>)</span><br><br><span class="hljs-comment"># ARCHIVE = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/add-native.a</span><br>ARCHIVE   = <span class="hljs-variable">$(WORK_DIR)</span>/build/<span class="hljs-variable">$(NAME)</span>-<span class="hljs-variable">$(ARCH)</span>.a<br><br><span class="hljs-comment">### Collect the files to be linked: object files (`.o`) and libraries (`.a`)</span><br><br><span class="hljs-comment"># OBJS = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/add.o</span><br>OBJS      = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(DST_DIR)</span>/, $(<span class="hljs-built_in">addsuffix</span> .o, $(<span class="hljs-built_in">basename</span> <span class="hljs-variable">$(SRCS)</span>)</span>))<br><br><span class="hljs-comment"># LIBS = (am klib)</span><br>LIBS     := <span class="hljs-variable">$(<span class="hljs-built_in">sort</span> <span class="hljs-variable">$(LIBS)</span> am klib)</span> <span class="hljs-comment"># lazy evaluation (&quot;=&quot;) causes infinite recursions</span><br><br><span class="hljs-comment"># LINKAGE = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/add.o /home/luyoung/ysyx-workbench/abstract-machine/am/build/am-native.a /home/luyoung/ysyx-workbench/abstract-machine/klib/build/klib-native.a</span><br>LINKAGE   = <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> -<span class="hljs-variable">$(ARCH)</span>.a, $(<span class="hljs-built_in">join</span> $(<span class="hljs-built_in">addsuffix</span> /build/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>),  <span class="hljs-variable">$(LIBS)</span> ))<br><br><span class="hljs-comment">## 3. General Compilation Flags</span><br><br><span class="hljs-comment">### (Cross) compilers, e.g., mips-linux-gnu-g++</span><br><br><span class="hljs-comment"># 目前 CROSS_COMPILE 为空，因此使用默认工具链，也就是 native 机器上的工具链</span><br>AS        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CC        = <span class="hljs-variable">$(CROSS_COMPILE)</span>gcc<br>CXX       = <span class="hljs-variable">$(CROSS_COMPILE)</span>g++<br>LD        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ld<br>AR        = <span class="hljs-variable">$(CROSS_COMPILE)</span>ar<br>OBJDUMP   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objdump<br>OBJCOPY   = <span class="hljs-variable">$(CROSS_COMPILE)</span>objcopy<br>READELF   = <span class="hljs-variable">$(CROSS_COMPILE)</span>readelf<br><br><br><br><br><span class="hljs-comment">### Compilation flags</span><br><br><span class="hljs-comment"># INC_PATH = /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include /home/luyoung/ysyx-workbench/abstract-machine/klib/include/ /home/luyoung/ysyx-workbench/abstract-machine/am/include/</span><br>INC_PATH += <span class="hljs-variable">$(WORK_DIR)</span>/<span class="hljs-keyword">include</span> <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> /include/, $(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(AM_HOME)</span>/, <span class="hljs-variable">$(LIBS)</span>)</span>)<br><br><span class="hljs-comment"># INCFLAGS = -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/</span><br>INCFLAGS += <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> -I, <span class="hljs-variable">$(INC_PATH)</span>)</span><br><br><br><span class="hljs-comment"># ARCH_H := arch/native.h</span><br>ARCH_H := arch/<span class="hljs-variable">$(ARCH)</span>.h<br><br><span class="hljs-comment">#CFLAGS   = -O2 -MMD -Wall -Werror -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ \</span><br>            -D__ISA__=native -D__ISA_NATIVE__ \<br>            -D__ARCH__=NATIVE -D__ARCH_NATIVE \<br>            -D__PLATFORM__ -D__PLATFORM_ \<br>            -DARCH_H=arch/native.h \<br>            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \<br>            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden<br><br>CFLAGS   += -O2 -MMD -Wall -Werror <span class="hljs-variable">$(INCFLAGS)</span> \<br>            -D__ISA__=\<span class="hljs-string">&quot;<span class="hljs-variable">$(ISA)\&quot;</span> -D__ISA_$(shell echo <span class="hljs-variable">$(ISA)</span> | tr a-z A-Z)__ \</span><br><span class="hljs-string">            -D__ARCH__=<span class="hljs-variable">$(ARCH)</span> -D__ARCH_$(shell echo <span class="hljs-variable">$(ARCH)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -D__PLATFORM__=<span class="hljs-variable">$(PLATFORM)</span> -D__PLATFORM_$(shell echo <span class="hljs-variable">$(PLATFORM)</span> | tr a-z A-Z | tr - _) \</span><br><span class="hljs-string">            -DARCH_H=\&quot;<span class="hljs-variable">$(ARCH_H)\&quot;</span> \</span><br><span class="hljs-string">            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \</span><br><span class="hljs-string">            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden</span><br><span class="hljs-string"></span><br><span class="hljs-string"># CXXFLAGS = -O2 -MMD -Wall -Werror -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ \</span><br><span class="hljs-string">            -D__ISA__=native -D__ISA_NATIVE__ \</span><br><span class="hljs-string">            -D__ARCH__=NATIVE -D__ARCH_NATIVE \</span><br><span class="hljs-string">            -D__PLATFORM__ -D__PLATFORM_ \</span><br><span class="hljs-string">            -DARCH_H=arch/native.h \</span><br><span class="hljs-string">            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \</span><br><span class="hljs-string">            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden -ffreestanding -fno-rtti -fno-exceptions</span><br><span class="hljs-string">CXXFLAGS +=  <span class="hljs-variable">$(CFLAGS)</span> -ffreestanding -fno-rtti -fno-exceptions</span><br><span class="hljs-string"></span><br><span class="hljs-string"># ASFLAGS = -MMD -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/</span><br><span class="hljs-string">ASFLAGS  += -MMD <span class="hljs-variable">$(INCFLAGS)</span></span><br><span class="hljs-string"></span><br><span class="hljs-string"># LDFLAGS = -z noexecstack</span><br><span class="hljs-string">LDFLAGS  += -z noexecstack</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment">## 4. Arch-Specific Configurations</span><br><br><span class="hljs-comment">### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)</span><br><span class="hljs-comment"># -include $(AM_HOME)/scripts/$(ARCH).mk</span><br><br><br>AM_SRCS := native/trm.c \<br>           native/ioe.c \<br>           native/cte.c \<br>           native/trap.S \<br>           native/vme.c \<br>           native/mpe.c \<br>           native/platform.c \<br>           native/ioe/input.c \<br>           native/ioe/timer.c \<br>           native/ioe/gpu.c \<br>           native/ioe/uart.c \<br>           native/ioe/audio.c \<br>           native/ioe/disk.c \<br><br><span class="hljs-comment"># CFLAGS 又加了些东西</span><br><span class="hljs-comment"># CFLAGS = -O2 -MMD -Wall -Werror -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ \</span><br>            -D__ISA__=native -D__ISA_NATIVE__ \<br>            -D__ARCH__=NATIVE -D__ARCH_NATIVE \<br>            -D__PLATFORM__ -D__PLATFORM_ \<br>            -DARCH_H=arch/native.h \<br>            -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \<br>            -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden -fpie<br><br><br>CFLAGS  += -fpie<br><br><span class="hljs-comment"># ASFLAGS = -MMD -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ -fpie -pie</span><br><br>ASFLAGS += -fpie -pie<br>comma = ,<br><br><span class="hljs-comment"># LDFLAGS_CXX = -Wl,-z noexecstack</span><br>LDFLAGS_CXX = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> -Wl<span class="hljs-variable">$(comma)</span>, <span class="hljs-variable">$(LDFLAGS)</span>)</span><br></code></pre></td></tr></table></figure>


<p>以上的变量分析完了，接下来就开始进行目标构建。</p>
<h3 id="3-目标构建"><a href="#3-目标构建" class="headerlink" title="3. 目标构建"></a>3. 目标构建</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">image:</span><br>	@echo + LD <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(IMAGE_REL)</span><br>	@g++ -pie -o <span class="hljs-variable">$(IMAGE)</span> -Wl,--whole-archive <span class="hljs-variable">$(LINKAGE)</span> -Wl,-no-whole-archive <span class="hljs-variable">$(LDFLAGS_CXX)</span> -lSDL2 -ldl<br><br><span class="hljs-section">run: image</span><br>	<span class="hljs-variable">$(IMAGE)</span><br><br><span class="hljs-section">gdb: image</span><br>	gdb -ex <span class="hljs-string">&quot;handle SIGUSR1 SIGUSR2 SIGSEGV noprint nostop&quot;</span> <span class="hljs-variable">$(IMAGE)</span><br><br><span class="hljs-comment">### Fall back to native gcc/binutils if there is no cross compiler</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> $(<span class="hljs-built_in">shell</span> which <span class="hljs-variable">$(CC)</span>)</span>),)<br>  <span class="hljs-variable">$(info #  <span class="hljs-variable">$(CC)</span> not found; fall back to default gcc <span class="hljs-built_in">and</span> binutils)</span><br>  CROSS_COMPILE :=<br><span class="hljs-keyword">endif</span><br><br><span class="hljs-comment">## 5. Compilation Rules</span><br><br><span class="hljs-comment">### Rule (compile): a single `.c` -&gt; `.o` (gcc)</span><br><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.c<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br><br><span class="hljs-comment">### Rule (compile): a single `.cc` -&gt; `.o` (g++)</span><br><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cc<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br><br><span class="hljs-comment">### Rule (compile): a single `.cpp` -&gt; `.o` (g++)</span><br><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.cpp<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CXX <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(CXX)</span> -std=c++17 <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br><br><span class="hljs-comment">### Rule (compile): a single `.S` -&gt; `.o` (gcc, which preprocesses and calls as)</span><br><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.S<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + AS <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(AS)</span> <span class="hljs-variable">$(ASFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br><br><span class="hljs-comment">### Rule (recursive make): build a dependent library (am, klib, ...)</span><br><span class="hljs-variable">$(LIBS)</span>: %:<br>	@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$(AM_HOME)</span>/<span class="hljs-variable">$*</span> archive<br><br><span class="hljs-comment">### Rule (link): objects (`*.o`) and libraries (`*.a`) -&gt; `IMAGE.elf`, the final ELF binary to be packed into image (ld)</span><br><span class="hljs-variable">$(IMAGE)</span>.elf: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span><br>	@echo + LD <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(IMAGE_REL)</span>.elf<br>	@<span class="hljs-variable">$(LD)</span> <span class="hljs-variable">$(LDFLAGS)</span> -o <span class="hljs-variable">$(IMAGE)</span>.elf --start-group <span class="hljs-variable">$(LINKAGE)</span> --end-group<br><br><span class="hljs-comment">### Rule (archive): objects (`*.o`) -&gt; `ARCHIVE.a` (ar)</span><br><span class="hljs-variable">$(ARCHIVE)</span>: <span class="hljs-variable">$(OBJS)</span><br>	@echo + AR <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-built_in">realpath</span> <span class="hljs-variable">$@</span> --relative-to .)</span><br>	@<span class="hljs-variable">$(AR)</span> rcs <span class="hljs-variable">$(ARCHIVE)</span> <span class="hljs-variable">$(OBJS)</span><br><br><span class="hljs-comment">### Rule (`#include` dependencies): paste in `.d` files generated by gcc on `-MMD`</span><br><span class="hljs-comment">#-include $(addprefix $(DST_DIR)/, $(addsuffix .d, $(basename $(SRCS))))</span><br><br><span class="hljs-section">/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/tests/add.o: \</span><br> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/tests/add.c \<br> /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/<span class="hljs-keyword">include</span>/trap.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/am.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/arch/native.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/am/<span class="hljs-keyword">include</span>/amdev.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/klib/<span class="hljs-keyword">include</span>/klib.h \<br> /home/luyoung/ysyx-workbench/abstract-machine/klib/<span class="hljs-keyword">include</span>/klib-macros.h<br><br><span class="hljs-comment">## 6. Miscellaneous</span><br><br><span class="hljs-comment">### Build order control</span><br><span class="hljs-section">image: image-dep</span><br><span class="hljs-section">archive: <span class="hljs-variable">$(ARCHIVE)</span></span><br><span class="hljs-section">image-dep: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br>	@echo \<span class="hljs-comment"># Creating image [$(ARCH)]</span><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: image image-dep archive run $(LIBS)</span><br><br><span class="hljs-comment">### Clean a single project (remove `build/`)</span><br><span class="hljs-section">clean:</span><br>	rm -rf Makefile.html <span class="hljs-variable">$(WORK_DIR)</span>/build/<br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><br><span class="hljs-comment">### Clean all sub-projects within depth 2 (and ignore errors)</span><br>CLEAN_ALL = <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(<span class="hljs-built_in">shell</span> find . -mindepth 2 -name Makefile)</span>)<br><span class="hljs-section">clean-all: <span class="hljs-variable">$(CLEAN_ALL)</span> clean</span><br><span class="hljs-variable">$(CLEAN_ALL)</span>:<br>	-@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$@</span> clean<br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean-all $(CLEAN_ALL)</span><br></code></pre></td></tr></table></figure>

<p>构建目标 <code>run</code>：</p>
<ul>
<li>它依赖于 <code>image</code>:</li>
<li><ul>
<li><code>iamge</code> 依赖于 <code>image-dep</code>,<code>image-dep</code>依赖于<code>$(OBJS)</code> <code>$(LIBS)</code>:</li>
</ul>
</li>
<li><ul>
<li><code>$(OBJS)</code>是：<code>/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/add.o</code>，它其实就是<code>$(DST_DIR)/%.o</code>，而它又依赖于 <code>%.c</code>,显然它存在，那就接着构建目标<code>$(DST_DIR)/%.o</code>：</li>
</ul>
</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.c<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br></code></pre></td></tr></table></figure>

<p>在 <code>Makefile</code> 中，这两个命令通常位于一个编译规则中，用于编译源代码文件生成对象文件（<code>.o</code> 文件）。下面是这两条命令的详细解释：</p>
<h3 id="第一条命令：创建目录并输出正在编译的文件名"><a href="#第一条命令：创建目录并输出正在编译的文件名" class="headerlink" title="第一条命令：创建目录并输出正在编译的文件名"></a>第一条命令：创建目录并输出正在编译的文件名</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>@</code>: 这个符号用于告诉 <code>make</code> 不要在执行命令时在控制台输出该命令本身。通常用于隐藏命令行，让输出更加干净。</li>
<li><code>mkdir -p $(dir $@)</code>: 这个命令用于创建目标文件所在的目录，确保在文件生成之前该目录存在。<code>$(dir $@)</code> 函数取得目标文件（<code>$@</code>）的目录部分。<code>-p</code> 参数确保了即使目录已经存在，命令也不会失败，并且能够创建所有必需的父目录。</li>
<li><code>&amp;&amp;</code>: 表示只有当 <code>mkdir</code> 命令成功执行后，才会执行后续的 <code>echo</code> 命令。</li>
<li><code>echo + CC $&lt;</code>: 这个命令输出正在被编译的源文件名，<code>$&lt;</code> 是 <code>make</code> 的自动变量，代表第一个依赖文件。</li>
</ul>
<h3 id="第二条命令：编译源文件生成对象文件"><a href="#第二条命令：编译源文件生成对象文件" class="headerlink" title="第二条命令：编译源文件生成对象文件"></a>第二条命令：编译源文件生成对象文件</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>$(CC)</code>: 这是 <code>make</code> 变量，通常在 <code>Makefile</code> 开头定义，指定使用的 C 编译器，如 <code>gcc</code>。</li>
<li><code>-std=gnu11</code>: 指定编译器使用 GNU C11 标准编译源代码。这个标准是 C11 标准的一个超集，包含了 GNU 的扩展。</li>
<li><code>$(CFLAGS)</code>: 这是一个常见的 <code>make</code> 变量，包含了应用于编译过程中的编译器标志，如优化级别、警告处理等。</li>
<li><code>-c</code>: 这个编译器选项告诉编译器生成对象文件，而不是完成链接生成可执行文件。</li>
<li><code>-o $@</code>: 指定输出文件的名称，<code>$@</code> 是 <code>make</code> 的自动变量，代表当前规则的目标文件。</li>
<li><code>$(realpath $&lt;)</code>: <code>realpath</code> 函数获取 <code>$&lt;</code>（当前依赖项，即源文件）的绝对路径，这有助于确保编译器可以无误地找到文件，特别是在源文件位于不同目录时。</li>
</ul>
<p><code>CFLAGS</code>在前面已经解析过了，它是：<code>-O2 -MMD -Wall -Werror -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ \             -D__ISA__=native -D__ISA_NATIVE__ \             -D__ARCH__=NATIVE -D__ARCH_NATIVE \             -D__PLATFORM__ -D__PLATFORM_ \             -DARCH_H=arch/native.h \             -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \             -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden -fpie</code></p>
<p>也就是说，它在构建二进制目标文件，而不是可执行文件，完整的命令为：</p>
<p><code>gcc -std=gnu11 -O2 -MMD -Wall -Werror -I/home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/include -I/home/luyoung/ysyx-workbench/abstract-machine/klib/include/ -I/home/luyoung/ysyx-workbench/abstract-machine/am/include/ \             -D__ISA__=native -D__ISA_NATIVE__ \             -D__ARCH__=NATIVE -D__ARCH_NATIVE \             -D__PLATFORM__ -D__PLATFORM_ \             -DARCH_H=arch/native.h \             -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector \             -Wno-main -U_FORTIFY_SOURCE -fvisibility=hidden -fpie -c -o /home/luyoung/ysyx-workbench/am-kernels/tests/cpu-tests/build/native/add.o add.c</code></p>
<p><code>OBJS</code> 被构建好了，接着构建<code>LIBS</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-variable">$(LIBS)</span>: %:<br>	@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$(AM_HOME)</span>/<span class="hljs-variable">$*</span> archive<br></code></pre></td></tr></table></figure>

<p>这段 <code>Makefile</code> 规则定义了一个所谓的 “recursive make” 过程，它用于构建依赖的库。让我们逐步分解这个规则的功能和组成：</p>
<h3 id="规则解释"><a href="#规则解释" class="headerlink" title="规则解释"></a>规则解释</h3><ol>
<li><p><strong>目标和模式规则</strong>:</p>
<ul>
<li><code>$(LIBS): %:</code> 这是一个模式规则，其中 <code>$(LIBS)</code> 应该是一个变量，列出了所有需要构建的库的名字。<code>%</code> 是一个模式匹配符，表示对于 <code>$(LIBS)</code> 中的每个元素，都应用这个规则，比如：<code>klib</code>、<code>am</code>。</li>
<li>这种使用模式的规则允许你为多个目标使用相同的构建命令，而不需要为每个目标单独写规则。</li>
</ul>
</li>
<li><p><strong>命令执行</strong>:</p>
<ul>
<li><code>@$(MAKE) -s -C $(AM_HOME)/$* archive</code> 这条命令是实际执行的操作：<ul>
<li><code>@</code>: 表示不在命令行输出这个命令，只显示其输出（如果有）。</li>
<li><code>$(MAKE)</code>: 这通常是 <code>make</code> 工具本身，用于调用另一个 <code>make</code> 进程。</li>
<li><code>-s</code>: 表示 “silent” 模式，不显示执行的命令，只显示命令的输出。</li>
<li><code>-C $(AM_HOME)/$*</code>: <code>-C</code> 选项告诉 <code>make</code> 更改到指定的目录再执行 <code>make</code> 命令。</li>
<li><code>$(AM_HOME)/$*</code> 是目标库所在的目录，其中 <code>$(AM_HOME)</code> 是一个环境变量，指向所有库的根目录，<code>$*</code> 是当前目标名称的自动变量，匹配到 <code>$(LIBS)</code> 中的每个库名。比如<code>$(AM_HOME)/am</code>, <code>$(AM_HOME)/klib</code>。</li>
<li><code>archive</code>: 是要在指定目录下执行的 <code>make</code> 目标。这通常指一个特定的 <code>Makefile</code> 目标，用于创建静态库（.a 文件）。这里的意思就是在<code>$(AM_HOME)/klib</code>目录下用<code>$(AM_HOME)/klib/Makefile</code>构建目标<code>archive</code>。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>我们来看看它是怎么构建目标<code>archive</code>的。</p>
<h3 id="构建-klib-的目标-archive"><a href="#构建-klib-的目标-archive" class="headerlink" title="构建 klib 的目标 archive"></a>构建 klib 的目标 archive</h3><p>我们可以看到，<code>$(AM_HOME)/klib/Makefile</code>中又包含了<code>$(AM_HOME)/Makefile</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME = klib<br>SRCS = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> find src/ -name &quot;*.c&quot;)</span><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(AM_HOME)</span>/Makefile<br><br></code></pre></td></tr></table></figure>
<p>可以看到这里覆盖了之前的 <code>NAME</code>、<code>SRCS</code>，其它没有任何变化。换句话说，这里又是一个全新的编译目标的过程，和前面的所有编译 add.c 没有任何区别：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME = add<br>SRCS = tests/add.c<br><span class="hljs-keyword">include</span> /home/luyoung/ysyx-workbench/abstract-machine/Makefile<br></code></pre></td></tr></table></figure>

<p>区别是，klib 中编译的SRCS 文件比较多，有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">ls</span> /home/luyoung/ysyx-workbench/abstract-machine/klib/src<br>cpp.c  int64.c  stdio.c  stdlib.c  string.c<br></code></pre></td></tr></table></figure>

<p>这里的解析过程和前面完全一致，就不赘述了，只是构建目标换成了 <code>archive</code>，而它又依赖于<code>$(ARCHIVE)</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-variable">$(ARCHIVE)</span>: <span class="hljs-variable">$(OBJS)</span><br>	@echo + AR <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-built_in">realpath</span> <span class="hljs-variable">$@</span> --relative-to .)</span><br>	@<span class="hljs-variable">$(AR)</span> rcs <span class="hljs-variable">$(ARCHIVE)</span> <span class="hljs-variable">$(OBJS)</span><br></code></pre></td></tr></table></figure>

<p>可以看到，<code>$(ARCHIVE)</code> 又依赖于 <code>$(OBJS)</code>。</p>
<p><code>$(OBJS)</code> 为<code>$(addprefix $(DST_DIR)/, $(addsuffix .o, $(basename $(SRCS))))</code>，也就是目标文件<code>$(DST_DIR)/%.o</code>。</p>
<p>当然，<code>$(DST_DIR)/%.o</code>又依赖于<code>%.c</code>，满足后，继续按照编译规则进行编译：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment">### Rule (compile): a single `.c` -&gt; `.o` (gcc)</span><br><span class="hljs-variable">$(DST_DIR)</span>/%.o: %.c<br>	@mkdir -p <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> <span class="hljs-variable">$@</span>)</span> &amp;&amp; echo + CC <span class="hljs-variable">$&lt;</span><br>	@<span class="hljs-variable">$(CC)</span> -std=gnu11 <span class="hljs-variable">$(CFLAGS)</span> -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">realpath</span> <span class="hljs-variable">$&lt;</span>)</span><br></code></pre></td></tr></table></figure>

<p>之后，就会进行编译目标文件了。</p>
<p>完成后，就会编译<code>$(ARCHIVE)</code>&#x3D;<code>$(WORK_DIR)/build/$(NAME)-$(ARCH).a</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-variable">$(ARCHIVE)</span>: <span class="hljs-variable">$(OBJS)</span><br>	@echo + AR <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-built_in">realpath</span> <span class="hljs-variable">$@</span> --relative-to .)</span><br>	@<span class="hljs-variable">$(AR)</span> rcs <span class="hljs-variable">$(ARCHIVE)</span> <span class="hljs-variable">$(OBJS)</span><br></code></pre></td></tr></table></figure>

<p>这段代码定义了一个 <code>Makefile</code> 规则，用于创建一个静态库文件，通常是 <code>.a</code> 文件。每一行的具体作用如下：</p>
<h3 id="规则解释-1"><a href="#规则解释-1" class="headerlink" title="规则解释"></a>规则解释</h3><ol>
<li><p><strong>目标和依赖关系</strong>:</p>
<ul>
<li><code>$(ARCHIVE): $(OBJS)</code>：这里，<code>$(ARCHIVE)</code> 是目标文件，它依赖于 <code>$(OBJS)</code>，即一组对象文件。<code>$(OBJS)</code> 变量应该包含了构建该静态库所需的所有对象文件的列表。</li>
</ul>
</li>
<li><p><strong>命令解释</strong>:</p>
<ul>
<li><p><code>@echo + AR &quot;-&gt;&quot; $(shell realpath $@ --relative-to .)</code>:</p>
<ul>
<li><code>@</code>: 表示该命令在执行时不被显示在终端，只显示其结果。</li>
<li><code>echo</code>: 用于输出文本。</li>
<li><code>+ AR &quot;-&gt;&quot;</code>: 这是一个简单的提示文本，表示正在执行的操作（AR 表示归档）。</li>
<li><code>$(shell realpath $@ --relative-to .)</code>: 这是一个 <code>shell</code> 函数调用，它调用 <code>realpath</code> 命令来获取目标文件 <code>$(ARCHIVE)</code> 的相对路径，<code>$@</code> 是自动变量，代表当前规则的目标文件。</li>
</ul>
</li>
<li><p><code>@$(AR) rcs $(ARCHIVE) $(OBJS)</code>:</p>
<ul>
<li><code>$(AR)</code>: 通常是 <code>ar</code> 工具，用于创建和修改静态库。</li>
<li><code>rcs</code>: 这是 <code>ar</code> 工具的选项，其中：<ul>
<li><code>r</code>：插入文件到归档（或替换归档中已存在的文件）。</li>
<li><code>c</code>：创建归档文件，如果不存在的话。</li>
<li><code>s</code>：写入索引到归档文件中，或更新已有的索引。</li>
</ul>
</li>
<li><code>$(ARCHIVE)</code>: 是静态库的文件名，目标文件。</li>
<li><code>$(OBJS)</code>: 需要被添加到归档中的对象文件列表。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>以上的过程就是为了将 klib 中所有的文件创建成静态库。</p>
<h3 id="构建-am-的目标-archive"><a href="#构建-am-的目标-archive" class="headerlink" title="构建 am 的目标 archive"></a>构建 am 的目标 archive</h3><p>同样，am 也是一样的，但是 <code>INC_PATH</code> 多了一些东西，这是因为 <code>am</code> 和 <code>klib</code> 是不同的。<code>am</code> 中的 <code>src</code> 中有一些头文件，而 <code>klib</code> 中的 <code>src</code> 没有头文件要查找：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">NAME     := am<br>SRCS      = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> src/, <span class="hljs-variable">$(AM_SRCS)</span>)</span><br>INC_PATH += <span class="hljs-variable">$(AM_HOME)</span>/am/src<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(AM_HOME)</span>/Makefile<br><br></code></pre></td></tr></table></figure>

<p>同样，又是相同的构建过程。就不累赘了，总之，也是创建了一个静态库<code>am-native.a</code></p>
<h3 id="继续编译add-c"><a href="#继续编译add-c" class="headerlink" title="继续编译add.c"></a>继续编译add.c</h3><p>完成下面的构建之后：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-variable">$(LIBS)</span>: %:<br>	@<span class="hljs-variable">$(MAKE)</span> -s -C <span class="hljs-variable">$(AM_HOME)</span>/<span class="hljs-variable">$*</span> archive<br></code></pre></td></tr></table></figure>
<p><code>$(LIBS)</code>就完成了构建，这时候，<code>image-dep</code>就不缺乏依赖了：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">image-dep: <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(LIBS)</span></span><br>	@echo \<span class="hljs-comment"># Creating image [$(ARCH)]</span><br></code></pre></td></tr></table></figure>

<p>完成构建之后，<code>image-dep</code>、<code>image</code>也就不缺乏依赖了，因此会直接执行：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">image:</span><br>	@echo + LD <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(IMAGE_REL)</span><br>	@g++ -pie -o <span class="hljs-variable">$(IMAGE)</span> -Wl,--whole-archive <span class="hljs-variable">$(LINKAGE)</span> -Wl,-no-whole-archive <span class="hljs-variable">$(LDFLAGS_CXX)</span> -lSDL2 -ldl<br></code></pre></td></tr></table></figure>

<p>然后，就会构建 <code>run</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">run: image</span><br>	<span class="hljs-variable">$(IMAGE)</span><br></code></pre></td></tr></table></figure>

<p>还没完，接着回到这里：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">all: $(addprefix Makefile., <span class="hljs-variable">$(ALL)</span>)</span><br>	@echo <span class="hljs-string">&quot;test list [$(words <span class="hljs-variable">$(ALL)</span>) item(s)]:&quot;</span> <span class="hljs-variable">$(ALL)</span><br><br><span class="hljs-variable">$(ALL)</span>: %: Makefile.%<br><br><br><br><span class="hljs-section">Makefile.%: tests/%.c latest</span><br>	@/bin/echo -e <span class="hljs-string">&quot;NAME = <span class="hljs-variable">$*</span>\nSRCS = <span class="hljs-variable">$&lt;</span>\ninclude $$&#123;AM_HOME&#125;/Makefile&quot;</span> &gt; <span class="hljs-variable">$@</span><br>	@if make -s -f <span class="hljs-variable">$@</span> ARCH=<span class="hljs-variable">$(ARCH)</span> <span class="hljs-variable">$(MAKECMDGOALS)</span>; then \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_GREEN)</span>PASS<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	<span class="hljs-keyword">else</span> \<br>		printf <span class="hljs-string">&quot;[%14s] <span class="hljs-variable">$(COLOR_RED)</span>***FAIL***<span class="hljs-variable">$(COLOR_NONE)\n</span>&quot;</span> <span class="hljs-variable">$*</span> &gt;&gt; <span class="hljs-variable">$(RESULT)</span>; \<br>	fi<br><span class="hljs-comment">#-@rm -f Makefile.$*</span><br><br><span class="hljs-section">run: all</span><br>	@cat <span class="hljs-variable">$(RESULT)</span><br>	@rm <span class="hljs-variable">$(RESULT)</span><br></code></pre></td></tr></table></figure>

<p>假设我们的 <code>make ARCH=native ALL=add run</code> 构建成功了，那么就会执行：<code>printf &quot;[%14s] $(COLOR_GREEN)PASS$(COLOR_NONE)\n&quot; $* &gt;&gt; $(RESULT);</code></p>
<p>然后 <code>Makefile.%</code> 构建完毕，接着构建 <code>all</code>:<code>@echo &quot;test list [$(words $(ALL)) item(s)]:&quot; $(ALL)</code>，这个命令执行的结果为：<code>test list [1 item(s)]: add</code>。</p>
<p>然后 all 就有了，然后构建 run：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">run: all</span><br>	@cat <span class="hljs-variable">$(RESULT)</span><br>	@rm <span class="hljs-variable">$(RESULT)</span><br><br></code></pre></td></tr></table></figure>

<p>至此，整个命令执行完毕：<code>make ARCH=native ALL=add run</code>。</p>
<h2 id="三、native-构建流程图"><a href="#三、native-构建流程图" class="headerlink" title="三、native 构建流程图"></a>三、native 构建流程图</h2><p><img src="https://raw.githubusercontent.com/Luyoung0001/picBed/main/native_add_test.png"></p>
<h2 id="四、细节分析"><a href="#四、细节分析" class="headerlink" title="四、细节分析"></a>四、细节分析</h2><p>这里会分析一下目标在构建的过程中，库是如何链接的，这里会结合相关源代码的调用、宏的控制关系，结合部分 make 输出信息来验证。</p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">image:</span><br>	@echo + LD <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-variable">$(IMAGE_REL)</span><br>	@g++ -pie -o <span class="hljs-variable">$(IMAGE)</span> -Wl,--whole-archive <span class="hljs-variable">$(LINKAGE)</span> -Wl,-no-whole-archive <span class="hljs-variable">$(LDFLAGS_CXX)</span> -lSDL2 -ldl<br></code></pre></td></tr></table></figure>
<p>、<br>命令展开后为：<br><code>g++ -pie -o add-native -Wl,--whole-archive am-native.a klib-native.a -Wl,-no-whole-archive -Wl,-z noexecstack -lSDL2 -ldl</code></p>
<p>这条命令是用来链接一个可执行文件 <code>add-native</code> 的。让我们逐步解释每个部分的含义：</p>
<ul>
<li><code>g++</code>: 这是调用 C++ 编译器 <code>g++</code>。</li>
<li><code>-pie</code>: 表示生成一个位置无关可执行文件（Position Independent Executable）。</li>
<li><code>-o add-native</code>: 指定输出文件名为 <code>add-native</code>。</li>
</ul>
<p>接下来是链接阶段的选项和库文件：</p>
<ul>
<li><code>-Wl,--whole-archive am-native.a klib-native.a -Wl,-no-whole-archive</code>: 这部分使用了链接器选项 <code>-Wl</code>，它告诉编译器将 <code>am-native.a</code> 和 <code>klib-native.a</code> 中的所有目标文件（<code>.o</code> 文件）都包含进来。<code>--whole-archive</code> 表示整个库文件都被包含，而不是只包含用到的目标文件。在 <code>-Wl,-no-whole-archive</code> 之后，链接器将恢复默认行为，即只链接程序中需要的目标文件。</li>
</ul>
<p>接下来是一些链接选项：</p>
<ul>
<li><code>-Wl,</code>: 通常 <code>-Wl</code> 用于传递给链接器 <code>ld</code> 的选项。</li>
<li><code>-z noexecstack</code>: 这个选项告诉链接器禁止在可执行文件的栈上执行代码，这是一种增强安全性的措施。</li>
<li><code>-lSDL2</code>: 这里 <code>-l</code> 选项指定链接 <code>SDL2</code> 库。<code>-l</code> 选项后面跟着的是库名，编译器会在系统库路径下寻找对应的库文件。</li>
<li><code>-ldl</code>: 这个 <code>-l</code> 选项指定链接 <code>dl</code> 库，它是动态链接库加载器的库文件。</li>
</ul>
<p>综合起来，这条命令的作用是编译并链接一个名为 <code>add-native</code> 的可执行文件，其中包含了 <code>am-native.a</code> 和 <code>klib-native.a</code> 中的所有目标文件，以及 <code>SDL2</code> 和 <code>dl</code> 这两个系统库。</p>
<p>整个执行过程的输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ make ARCH=native ALL=add run<br><span class="hljs-comment"># Building add-run [native]</span><br>+ CC tests/add.c<br><span class="hljs-comment"># Building am-archive [native]</span><br>+ CC src/native/trm.c<br>+ CC src/native/ioe.c<br>+ CC src/native/cte.c<br>+ AS src/native/trap.S<br>+ CC src/native/vme.c<br>+ CC src/native/mpe.c<br>+ CC src/native/platform.c<br>+ CC src/native/ioe/input.c<br>+ CC src/native/ioe/timer.c<br>+ CC src/native/ioe/gpu.c<br>+ CC src/native/ioe/uart.c<br>+ CC src/native/ioe/audio.c<br>+ CC src/native/ioe/disk.c<br>+ AR -&gt; build/am-native.a<br><span class="hljs-comment"># Building klib-archive [native]</span><br>+ CC src/stdlib.c<br>+ CC src/int64.c<br>+ CC src/cpp.c<br>+ CC src/string.c<br>+ CC src/stdio.c<br>+ AR -&gt; build/klib-native.a<br><span class="hljs-comment"># Creating image [native]</span><br>+ LD -&gt; build/add-native<br>Exit code = 00h<br><span class="hljs-built_in">test</span> list [1 item(s)]: add<br>[           add] PASS<br></code></pre></td></tr></table></figure>

<p>整个过程都符合预期，它分别构建 <code>add.o</code>、 <code>am</code>、<code>klib</code>、然后链接成 <code>add-native</code>，完成构建。</p>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><h4 id="编译-add-c"><a href="#编译-add-c" class="headerlink" title="编译 add.c"></a>编译 add.c</h4><p><code>add.c</code> 包含了一个头文件 <code>trap.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __TRAP_H__</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __TRAP_H__</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;am.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;klib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;klib-macros.h&gt;</span></span><br><br>__attribute__((noinline))<br><span class="hljs-type">void</span> <span class="hljs-title function_">check</span><span class="hljs-params">(<span class="hljs-type">bool</span> cond)</span> &#123;<br>  <span class="hljs-keyword">if</span> (!cond) halt(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br></code></pre></td></tr></table></figure>

<p><code>trap.h</code>的含义是 <code>add.c</code> 中的任何符号与这个头文件相关，编译目标文件的时候，只要能通过递归查找，找到函数声明就能通过编译，因此<code>add.c</code> 中的符号都可以使用声明在 <code>trap.h</code>中的函数或者符号。但是，<code>add.c</code>中目前确实也没啥多余的符号只有一个<code>check</code>;</p>
<h4 id="编译-klib"><a href="#编译-klib" class="headerlink" title="编译 klib"></a>编译 klib</h4><p>klib 中有 5 个文件需要编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">ls</span><br>cpp.c  int64.c  stdio.c  stdlib.c  string.c<br></code></pre></td></tr></table></figure>

<p>比如在 <code>string.c</code> 中，它同样包含了一些头文件，这些头文件可以给 <code>string.c</code>中的符号提供声明，比如宏、或者一些需要递归查询的头文件。</p>
<h4 id="编译-am"><a href="#编译-am" class="headerlink" title="编译 am"></a>编译 am</h4><p><code>am</code> 中有很多的源文件，这个和 <code>klib</code> 一样，不在累赘。</p>
<h3 id="研究编译参数"><a href="#研究编译参数" class="headerlink" title="研究编译参数"></a>研究编译参数</h3><p>这些编译参数用于控制 <code>gcc</code> 或 <code>g++</code> 编译器的行为。它们影响代码优化、警告、错误处理、安全性、可移植性等方面。下面是每个编译参数的详细解释：</p>
<h3 id="通用参数-CFLAGS-CXXFLAGS-ASFLAGS"><a href="#通用参数-CFLAGS-CXXFLAGS-ASFLAGS" class="headerlink" title="通用参数 (CFLAGS, CXXFLAGS, ASFLAGS)"></a>通用参数 (<code>CFLAGS</code>, <code>CXXFLAGS</code>, <code>ASFLAGS</code>)</h3><ol>
<li><p><strong><code>-O2</code></strong>: 启用优化级别 2，表示在不影响编译时间太多的情况下优化代码性能。常见的优化包括消除不必要的代码、循环展开、常量折叠等。</p>
</li>
<li><p><strong><code>-MMD</code></strong>: 生成依赖文件（<code>.d</code> 文件），但不包括系统头文件。这用于自动追踪依赖项，帮助构建系统（如 <code>make</code>）知道在源文件改变时需要重新编译哪些文件。</p>
</li>
<li><p><strong><code>-Wall</code></strong>: 启用几乎所有的常见警告，这可以帮助捕获潜在的错误或不好的编程习惯。</p>
</li>
<li><p><strong><code>-Werror</code></strong>: 将所有的警告视为错误，如果有警告就终止编译。目的是保证代码严格遵循编译器的最佳实践。</p>
</li>
<li><p><strong><code>-fno-asynchronous-unwind-tables</code></strong>: 禁用异步展开表，通常用于减少生成的二进制文件的大小，因为展开表用于异常处理，而在某些环境下不需要。</p>
</li>
<li><p><strong><code>-fno-builtin</code></strong>: 禁止编译器使用内置函数。这可以防止编译器优化某些标准函数调用（如 <code>memcpy</code> 或 <code>printf</code>），强制它使用你自己实现的版本。</p>
</li>
<li><p><strong><code>-fno-stack-protector</code></strong>: 禁用堆栈保护机制。堆栈保护器用于检测和防止缓冲区溢出攻击。如果禁用它，则不会在堆栈上放置 “canary” 值。</p>
</li>
<li><p><strong><code>-Wno-main</code></strong>: 禁用关于 <code>main</code> 函数的警告。例如，如果你不使用标准的 <code>main</code> 函数声明，编译器可能会发出警告，而该选项会抑制这些警告。</p>
</li>
<li><p><strong><code>-U_FORTIFY_SOURCE</code></strong>: 取消定义 <code>FORTIFY_SOURCE</code> 宏。<code>FORTIFY_SOURCE</code> 是一个安全功能，用于检查某些函数调用（如 <code>memcpy</code> 和 <code>strcpy</code>）的安全性。禁用它可能是为了提高性能或在不需要的情况下关闭这些安全检查。</p>
</li>
<li><p><strong><code>-fvisibility=hidden</code></strong>: 将符号的默认可见性设置为隐藏。通常用于限制库的导出符号，使得只有明确标记为导出的符号可用于动态链接。</p>
</li>
</ol>
<h3 id="特定编译语言的参数-CXXFLAGS-ASFLAGS"><a href="#特定编译语言的参数-CXXFLAGS-ASFLAGS" class="headerlink" title="特定编译语言的参数 (CXXFLAGS, ASFLAGS)"></a>特定编译语言的参数 (<code>CXXFLAGS</code>, <code>ASFLAGS</code>)</h3><ul>
<li><p><strong><code>CXXFLAGS += $(CFLAGS) -ffreestanding -fno-rtti -fno-exceptions</code></strong>:</p>
<ul>
<li><code>-ffreestanding</code>: 表示编译器不依赖标准库。适用于操作系统内核或嵌入式系统的开发。</li>
<li><code>-fno-rtti</code>: 禁用运行时类型信息 (RTTI)，减少代码大小并提高性能。</li>
<li><code>-fno-exceptions</code>: 禁用 C++ 异常处理，进一步减少代码大小和运行时开销。</li>
</ul>
</li>
<li><p><strong><code>ASFLAGS  += -MMD $(INCFLAGS)</code></strong>:</p>
<ul>
<li><code>-MMD</code>: 同样生成依赖文件，这里用于汇编代码。</li>
<li><code>$(INCFLAGS)</code>: 包含头文件搜索路径等相关标志。</li>
</ul>
</li>
</ul>
<h3 id="链接器参数-LDFLAGS"><a href="#链接器参数-LDFLAGS" class="headerlink" title="链接器参数 (LDFLAGS)"></a>链接器参数 (<code>LDFLAGS</code>)</h3><ol>
<li><strong><code>-z noexecstack</code></strong>: 设置堆栈不可执行。这是一个安全措施，防止攻击者通过在堆栈上执行代码（如 shellcode）进行攻击。</li>
</ol>
<h3 id="链接规则"><a href="#链接规则" class="headerlink" title="链接规则"></a>链接规则</h3><p>当我在 <code>klib.h</code> 中通过控制是否定义 <code>__NATIVE_USE_KLIB__</code>这个宏来实现条件编译，当我不编译某些函数的时候，它就会默认链接到 <code>glibc</code>；如果我编译这些函数，它被包含到 <code>native-klib.a</code> 中，然后链接，就会使用我自己实现的 <code>klib</code>。</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p><code>$(AM_HOME)/Makefile</code> 的一些关键变量：</p>
<ul>
<li><code>WORK_DIR</code>: 假设 <code>A</code> 包含<code>$(AM_HOME)/Makefile</code>，那么这个动作目录就是 <code>A</code> 所在的目录；</li>
<li><code>DST_DIR</code>: <code>A</code> 所在的目录下的<code>/build/$(ARCH)</code>；</li>
<li><code>IMAGE_REL</code>: 二进制镜像的相对目录；</li>
<li><code>IMAGE</code>: 绝对目录；</li>
<li><code>ARCHIVE</code>: 静态库，klib.a ,am.a</li>
<li><code>OBJS</code>: 源文件.o，目标文件</li>
<li><code>LIBS</code>: klib、am</li>
<li><code>LINKAGE</code>: 源文件.o、klib.a、am.a，链接文件，影响链接能否成功；</li>
<li><code>INC_PATH</code>: 符号搜索路径，影响编译是否成功。</li>
</ul>
<p>以上就是对<code>make ARCH=native ALL=add run</code>的解析。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/RISCV/" class="category-chain-item">RISCV</a>
  
  
    <span>></span>
    
  <a href="/categories/RISCV/PA/" class="category-chain-item">PA</a>
  
  
    <span>></span>
    
  <a href="/categories/RISCV/PA/%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="category-chain-item">虚拟机</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/NEMU/" class="print-no-link">#NEMU</a>
      
        <a href="/tags/PA2/" class="print-no-link">#PA2</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>nemu框架细节研究（一）</div>
      <div>http://blog.luliang.online/2024/09/07/nemu框架细节研究(一)/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Luyoung</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年9月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/10/Ubuntu22.04%E8%AE%BE%E7%BD%AE/" title="Ubuntu 22.04 配置">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Ubuntu 22.04 配置</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/08/26/4th_semester_%E6%80%BB%E7%BB%93/" title="大二下学期学习总结">
                        <span class="hidden-mobile">大二下学期学习总结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
