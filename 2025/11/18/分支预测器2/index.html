

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://raw.githubusercontent.com/Luyoung0001/picBed/main/low.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Luyoung">
  <meta name="keywords" content="">
  
    <meta name="description" content="分支预测器性能统计基本信息当 branch_request_i 拉高：  RAS 学习如果 BTB 命中或者不命中： btb_pc_q 更新：btb_pc_q[btb_wr_entry_r]     &lt;&#x3D; branch_source_i btb_is_call_q 更新：btb_is_call_q[btb_wr_entry_r]&lt;&#x3D; branch_is_call_i btb_is_re">
<meta property="og:type" content="article">
<meta property="og:title" content="biriscv_npc 性能分析">
<meta property="og:url" content="http://blog.luliang.online/2025/11/18/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A82/index.html">
<meta property="og:site_name" content="Luyoung">
<meta property="og:description" content="分支预测器性能统计基本信息当 branch_request_i 拉高：  RAS 学习如果 BTB 命中或者不命中： btb_pc_q 更新：btb_pc_q[btb_wr_entry_r]     &lt;&#x3D; branch_source_i btb_is_call_q 更新：btb_is_call_q[btb_wr_entry_r]&lt;&#x3D; branch_is_call_i btb_is_re">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-11-18T07:03:13.000Z">
<meta property="article:modified_time" content="2026-01-24T09:00:40.450Z">
<meta property="article:author" content="Luyoung">
<meta property="article:tag" content="分支预测">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>biriscv_npc 性能分析 - Luyoung</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.luliang.online","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 65vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Luyoung</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/Luyoung0001/picBed/main/1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="biriscv_npc 性能分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-18 15:03" pubdate>
          2025年11月18日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          28 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">biriscv_npc 性能分析</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="分支预测器性能统计"><a href="#分支预测器性能统计" class="headerlink" title="分支预测器性能统计"></a>分支预测器性能统计</h2><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>当 <code>branch_request_i</code> 拉高：</p>
<ul>
<li>RAS 学习<br>如果 BTB 命中或者不命中：</li>
<li>btb_pc_q 更新：<code>btb_pc_q[btb_wr_entry_r]     &lt;= branch_source_i</code></li>
<li>btb_is_call_q 更新：<code>btb_is_call_q[btb_wr_entry_r]&lt;= branch_is_call_i</code></li>
<li>btb_is_ret_q 更新：<code>btb_is_ret_q[btb_wr_entry_r] &lt;= branch_is_ret_i</code></li>
<li>btb_is_jmp_q 更新：<code>btb_is_jmp_q[btb_wr_entry_r] &lt;= branch_is_jmp_i</code></li>
</ul>
<p>或者没命中，也会记录这些信息：</p>
<ul>
<li>btb_pc_q 更新：<code>btb_pc_q[btb_wr_alloc_w]     &lt;= branch_source_i</code></li>
<li>btb_is_call_q 更新<code>btb_target_q[btb_wr_alloc_w] &lt;= branch_pc_i</code></li>
<li>btb_is_ret_q 更新：<code>btb_is_call_q[btb_wr_alloc_w]&lt;= branch_is_call_i</code></li>
<li>btb_is_ret_q 更新：<code>btb_is_ret_q[btb_wr_alloc_w] &lt;= branch_is_ret_i</code></li>
<li>btb_is_jmp_q 更新：<code>btb_is_jmp_q[btb_wr_alloc_w] &lt;= branch_is_jmp_i</code></li>
</ul>
<p>总之，只要 <code>branch_request_i</code> 拉高，BTB 中一定会记录一个 PC 的情况，这是为了学习。</p>
<p>注意，此时 BTB 中的 <code>&#123;pc:npc&#125;</code> 中只有 <code>btb_pc_q</code> 更新，<code>btb_target_q</code> 并没有更新。只有当 <code>branch_is_taken_i</code> 拉高的时候，它才会更新：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">if</span> (branch_is_taken_i)<br>        btb_target_q[btb_wr_entry_r] &lt;= branch_pc_i;<br></code></pre></td></tr></table></figure>

<p>其实就算不拉高，相当于也在更新了，因为默认npc &#x3D; pc+8。只是更新没有意义，考虑到功耗，不用更新了。</p>
<p>当 <code>branch_is_taken_i</code> 或者 <code>branch_is_not_taken_i</code> 拉高：</p>
<ul>
<li>bht_sat_q 就开始饱和计数。</li>
</ul>
<h2 id="性能统计"><a href="#性能统计" class="headerlink" title="性能统计"></a>性能统计</h2><h3 id="为什么-branch-request-i-会拉高呢？"><a href="#为什么-branch-request-i-会拉高呢？" class="headerlink" title="为什么 branch_request_i 会拉高呢？"></a>为什么 <code>branch_request_i</code> 会拉高呢？</h3><p>当前端的 issue 部件发现两个指令都不是期望的指令时，这时候就会发射一组信号来修正 npc 部件的 next_pc 生成，这样 refetch 的时候 npc 就会发出正确的 PC，从而 issue 部件拿到期望的指令：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fetch0_valid_i || fetch1_valid_i)<br>        mispredicted_r = <span class="hljs-number">1&#x27;b1</span>;<br><br>...<br><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-comment">// Branch predictor info</span><br><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-comment">// This info is used to learn future prediction, and to correct</span><br><span class="hljs-comment">// BTB, BHT, GShare, RAS indexes on mispredictions.</span><br><span class="hljs-keyword">assign</span> branch_info_request_o      = mispredicted_r;<br><span class="hljs-keyword">assign</span> branch_info_is_taken_o     = (pipe1_branch_e1_w &amp; branch_exec1_is_taken_i)     | (pipe0_branch_e1_w &amp; branch_exec0_is_taken_i);<br><span class="hljs-keyword">assign</span> branch_info_is_not_taken_o = (pipe1_branch_e1_w &amp; branch_exec1_is_not_taken_i) | (pipe0_branch_e1_w &amp; branch_exec0_is_not_taken_i);<br><span class="hljs-keyword">assign</span> branch_info_is_call_o      = (pipe1_branch_e1_w &amp; branch_exec1_is_call_i)      | (pipe0_branch_e1_w &amp; branch_exec0_is_call_i);<br><span class="hljs-keyword">assign</span> branch_info_is_ret_o       = (pipe1_branch_e1_w &amp; branch_exec1_is_ret_i)       | (pipe0_branch_e1_w &amp; branch_exec0_is_ret_i);<br><span class="hljs-keyword">assign</span> branch_info_is_jmp_o       = (pipe1_branch_e1_w &amp; branch_exec1_is_jmp_i)       | (pipe0_branch_e1_w &amp; branch_exec0_is_jmp_i);<br><span class="hljs-keyword">assign</span> branch_info_source_o       = (pipe1_branch_e1_w &amp; branch_exec1_request_i)      ? branch_exec1_source_i : branch_exec0_source_i;<br><span class="hljs-keyword">assign</span> branch_info_pc_o           = (pipe1_branch_e1_w &amp; branch_exec1_request_i)      ? branch_exec1_pc_i     : branch_exec0_pc_i;<br><br></code></pre></td></tr></table></figure>

<p>这意味着如果 <code>branch_request_i</code> 拉高，一定是分支预测错误（一定是分支指令，如果不是，就会+8，但是为了万无一失，这里需要 trace 验证），或者是方向，或者是目标；如果 <code>branch_request_i</code> 没有拉高，说明预测单元给出的 npc 是正确的，但不意味着此时做出了分支预测（这是必然的，不需要验证）。</p>
<p>因此，一个思路是：</p>
<ul>
<li>判断 PC 对应的指令是分支指令(跳转、call、ret等)的次数 M；</li>
<li>统计 branch_request_i 拉高的次数 N。</li>
</ul>
<p>分支预测正确率就是 <code>((N/M)*100) %</code>。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>经过验证，<code>branch_request_i</code> 拉高，它的指令不一定是分支指令。因此结论为：如果 <code>branch_request_i</code> 拉高，一定是不期待的指令，但不一定是分支指令。</p>
<h2 id="指令流的顺序"><a href="#指令流的顺序" class="headerlink" title="指令流的顺序"></a>指令流的顺序</h2><p>首先需要搞清楚 frontend 数据通路。</p>
<h3 id="riscv-top-顶层架构图"><a href="#riscv-top-顶层架构图" class="headerlink" title="riscv_top 顶层架构图"></a>riscv_top 顶层架构图</h3><p>这个顶层包含三个主要模块：icache(指令缓存)、dcache(数据缓存) 和riscv_core(CPU核心)，对外暴露 axi 总线，对内分别连接 icache、dcache。</p>
<pre><code class=" mermaid">graph TB
    subgraph riscv_top[&quot;riscv_top 顶层模块&quot;]
        Core[&quot;riscv_core&lt;br/&gt;CPU核心&quot;]
        ICache[&quot;icache&lt;br/&gt;指令缓存&quot;]
        DCache[&quot;dcache&lt;br/&gt;数据缓存&quot;]
        %% 指令通路
        Core --&gt;|&quot;icache_pc_w[31:0]&lt;br/&gt;icache_rd_w&quot;| ICache
        ICache --&gt;|&quot;icache_inst_w[63:0]&lt;br/&gt;icache_valid_w&lt;br/&gt;icache_accept_w&lt;br/&gt;icache_error_w&quot;| Core
        %% 数据通路
        Core --&gt;|&quot;dcache_addr_w[31:0]&lt;br/&gt;dcache_data_wr_w[31:0]&lt;br/&gt;dcache_rd_w&lt;br/&gt;dcache_wr_w[3:0]&quot;| DCache
        DCache --&gt;|&quot;dcache_data_rd_w[31:0]&lt;br/&gt;dcache_ack_w&lt;br/&gt;dcache_accept_w&lt;br/&gt;dcache_error_w&quot;| Core
        %% 控制信号
        Core -.-&gt;|&quot;icache_flush_w&lt;br/&gt;icache_invalidate_w&quot;| ICache
        Core -.-&gt;|&quot;dcache_flush_w&lt;br/&gt;dcache_invalidate_w&quot;| DCache
    end
    %% 外部接口
    AXI_I[&quot;AXI总线&lt;br/&gt;(指令)&quot;]
    AXI_D[&quot;AXI总线&lt;br/&gt;(数据)&quot;]
    RST[&quot;复位/中断&lt;br/&gt;reset_vector_i&lt;br/&gt;intr_i&quot;]
    ICache &lt;--&gt;|&quot;axi_i_*&quot;| AXI_I
    DCache &lt;--&gt;|&quot;axi_d_*&quot;| AXI_D
    RST --&gt; Core
    style Core fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    style ICache fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style DCache fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style AXI_I fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style AXI_D fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
</code></pre>

<p>riscv_core 是一个核心，它包含这些部件：</p>
<ul>
<li>biriscv_frontend：</li>
<li>biriscv_mmu：</li>
<li>biriscv_lsu：</li>
<li>biriscv_csr：</li>
<li>biriscv_multiplier：</li>
<li>biriscv_divider：</li>
<li>biriscv_issue：</li>
<li>biriscv_exec：u_exec0，u_exec1</li>
</ul>
<p>riscv_core 数据通路说明：</p>
<ul>
<li>前端 → 发射：双指令流 (fetch0&#x2F;fetch1)</li>
<li>发射 → 执行：双发射到两个执行单元 + 乘法器 + LSU + CSR</li>
<li>执行 → 写回：所有执行单元的结果写回到 Issue 单元</li>
<li>分支控制：执行单元计算分支结果反馈到前端</li>
<li>访存通路：通过 MMU 连接到外部存储</li>
</ul>
<pre><code class=" mermaid">graph TB
    subgraph riscv_core[&quot;riscv_core CPU核心&quot;]
        direction TB

        subgraph Frontend[&quot;前端 (Frontend)&quot;]
            FE[&quot;biriscv_frontend&lt;br/&gt;取指+分支预测+解码&quot;]
        end

        subgraph Backend[&quot;后端 (Backend)&quot;]
            MMU[&quot;biriscv_mmu&lt;br/&gt;MMU/地址翻译&quot;]
            Issue[&quot;biriscv_issue&lt;br/&gt;指令发射/寄存器堆&quot;]

            subgraph Execution[&quot;执行单元&quot;]
                Exec0[&quot;biriscv_exec&lt;br/&gt;执行单元0&lt;br/&gt;(ALU/Branch)&quot;]
                Exec1[&quot;biriscv_exec&lt;br/&gt;执行单元1&lt;br/&gt;(ALU/Branch)&quot;]
                Mul[&quot;biriscv_multiplier&lt;br/&gt;乘法器&quot;]
                Div[&quot;biriscv_divider&lt;br/&gt;除法器&quot;]
            end

            LSU[&quot;biriscv_lsu&lt;br/&gt;Load/Store单元&quot;]
            CSR[&quot;biriscv_csr&lt;br/&gt;控制状态寄存器&quot;]
        end

        %% 取指通路
        FE --&gt;|&quot;fetch0/1_valid&lt;br/&gt;fetch0/1_instr[31:0]&lt;br/&gt;fetch0/1_pc[31:0]&quot;|Issue

        %% 指令发射
        Issue --&gt;|&quot;opcode0_*&lt;br/&gt;(opcode/pc/operands)&quot;| Exec0
        Issue --&gt;|&quot;opcode1_*&lt;br/&gt;(opcode/pc/operands)&quot;| Exec1
        Issue --&gt;|&quot;mul_opcode_*&quot;| Mul
        Issue --&gt;|&quot;lsu_opcode_*&quot;| LSU
        Issue --&gt;|&quot;csr_opcode_*&quot;| CSR
        Exec0 -.-&gt;|&quot;div_opcode_*&quot;| Div

        %% 写回通路
        Exec0 --&gt;|&quot;writeback_exec0_value_w&quot;| Issue
        Exec1 --&gt;|&quot;writeback_exec1_value_w&quot;| Issue
        Mul --&gt;|&quot;writeback_mul_value_w&quot;| Issue
        Div --&gt;|&quot;writeback_div_value/valid_w&quot;| Issue
        LSU --&gt;|&quot;writeback_mem_value/valid_w&quot;| Issue
        CSR --&gt;|&quot;csr_result_e1_value_w&quot;| Issue

        %% 分支反馈
        Exec0 --&gt;|&quot;branch_exec0_*&quot;| Issue
        Exec1 --&gt;|&quot;branch_exec1_*&quot;| Issue
        Issue --&gt;|&quot;branch_request/pc/priv&quot;| FE
        CSR --&gt;|&quot;branch_csr_*&quot;| Issue

        %% LSU 访存通路
        LSU --&gt;|&quot;mmu_lsu_addr_w&lt;br/&gt;mmu_lsu_data_wr_w&lt;br/&gt;mmu_lsu_rd/wr_w&quot;| MMU
        MMU --&gt;|&quot;mmu_lsu_data_rd_w&lt;br/&gt;mmu_lsu_ack_w&quot;| LSU

        %% 取指访存通路
        FE --&gt;|&quot;mmu_ifetch_pc_w&lt;br/&gt;mmu_ifetch_rd_w&quot;| MMU
        MMU --&gt;|&quot;mmu_ifetch_inst_w[63:0]&lt;br/&gt;mmu_ifetch_valid_w&quot;| FE

        %% CSR 控制
        CSR -.-&gt;|&quot;mmu_priv/satp/flush&quot;| MMU
        CSR -.-&gt;|&quot;take_interrupt&lt;br/&gt;ifence&quot;| Issue
    end

    %% 外部接口
    IMEM[&quot;指令存储&lt;br/&gt;(ICache)&quot;]
    DMEM[&quot;数据存储&lt;br/&gt;(DCache)&quot;]

    MMU &lt;--&gt;|&quot;mem_i_pc_o[31:0]&lt;br/&gt;mem_i_inst_i[63:0]&quot;| IMEM
    MMU &lt;--&gt;|&quot;mem_d_addr_o[31:0]&lt;br/&gt;mem_d_data_wr/rd_o&quot;| DMEM

    style FE fill:#ffe0b2,stroke:#e65100,stroke-width:3px
    style Issue fill:#b3e5fc,stroke:#01579b,stroke-width:3px
    style Exec0 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style Exec1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style Mul fill:#f0f4c3,stroke:#827717,stroke-width:2px
    style Div fill:#f0f4c3,stroke:#827717,stroke-width:2px
    style LSU fill:#e1bee7,stroke:#6a1b9a,stroke-width:2px
    style CSR fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style MMU fill:#b2dfdb,stroke:#00695c,stroke-width:2px
</code></pre>

<h2 id="biriscv-frontend"><a href="#biriscv-frontend" class="headerlink" title="biriscv_frontend"></a>biriscv_frontend</h2><p>这里有三个内部模块：biriscv_npc、biriscv_decode、biriscv_fetch。</p>
<h3 id="biriscv-npc"><a href="#biriscv-npc" class="headerlink" title="biriscv_npc"></a>biriscv_npc</h3><p>biriscv_npc 的作用是计算 next_pc + 分支预测，将 next_pc_f_o 和 next_taken_f_o 发射到 biriscv_fetch 部件。issue 部件将 npc 反馈信息发到 frontend，最终到达 biriscv_npc。issue 的分支反馈信息来源于 biriscv_exec 执行部件。</p>
<h3 id="biriscv-fetch"><a href="#biriscv-fetch" class="headerlink" title="biriscv_fetch"></a>biriscv_fetch</h3><p>fetch 拿到来自 icache 经过 mmu 处理过的地址的指令后，将：</p>
<ul>
<li>fetch_valid_w：</li>
<li>fetch_instr_w[63:0]:</li>
<li>fetch_pc_w:</li>
</ul>
<p>等信号发往 biriscv_decode 单元。</p>
<h3 id="biriscv-decode"><a href="#biriscv-decode" class="headerlink" title="biriscv_decode"></a>biriscv_decode</h3><p>decode 单元拿到这些信号后，对数据进行解析，然后将数据发送到 issue 模块（双发射）。</p>
<pre><code class=" mermaid">
graph TB
    subgraph biriscv_frontend[&quot;biriscv_frontend 前端模块&quot;]
        direction TB

        NPC[&quot;biriscv_npc&lt;br/&gt;下一PC计算&lt;br/&gt;+分支预测&lt;br/&gt;(BTB/BHT/RAS)&quot;]
        Fetch[&quot;biriscv_fetch&lt;br/&gt;取指单元&lt;br/&gt;PC管理&quot;]
        Decode[&quot;biriscv_decode&lt;br/&gt;解码单元&lt;br/&gt;(双发射)&quot;]

        %% NPC 计算
        NPC --&gt;|&quot;next_pc_f_w[31:0]&lt;br/&gt;next_taken_f_w[1:0]&lt;br/&gt;(预测信息)&quot;| Fetch
        Fetch --&gt;|&quot;fetch_pc_f_w[31:0]&lt;br/&gt;fetch_pc_accept_w&lt;br/&gt;(当前PC)&quot;| NPC

        %% 取指通路
        Fetch --&gt;|&quot;fetch_valid_w&lt;br/&gt;fetch_instr_w[63:0]&lt;br/&gt;fetch_pc_w[31:0]&lt;br/
&gt;fetch_pred_branch_w[1:0]&quot;| Decode

        %% 解码输出
        Decode --&gt;|&quot;fetch0_valid_o&lt;br/&gt;fetch0_instr_o[31:0]&lt;br/&gt;fetch0_pc_o[31:0]
&lt;br/&gt;+控制信号&quot;| Out0[&quot;发射单元&lt;br/&gt;Instruction 0&quot;]
        Decode --&gt;|&quot;fetch1_valid_o&lt;br/&gt;fetch1_instr_o[31:0]&lt;br/&gt;fetch1_pc_o[31:0]
&lt;br/&gt;+控制信号&quot;| Out1[&quot;发射单元&lt;br/&gt;Instruction 1&quot;]

        %% 反压信号
        Out0 --&gt;|&quot;fetch0_accept_i&quot;| Decode
        Out1 --&gt;|&quot;fetch1_accept_i&quot;| Decode
        Decode --&gt;|&quot;fetch_accept_w&quot;| Fetch

        %% 分支反馈
        Branch[&quot;分支反馈&lt;br/&gt;(来自执行单元)&quot;]
-.-&gt;|&quot;branch_request_i&lt;br/&gt;branch_pc_i[31:0]&quot;| Fetch
        Branch -.-&gt;|&quot;branch_request_i&lt;br/&gt;branch_pc_i[31:0]&quot;| Decode
        BranchInfo[&quot;分支结果&lt;br/&gt;(实际执行)&quot;]
-.-&gt;|&quot;branch_info_request_i&lt;br/&gt;branch_info_is_taken/not_taken_i&lt;br/&gt;branch_info_
source/pc_i&lt;br/&gt;branch_info_is_call/ret/jmp_i&quot;| NPC
    end

    %% 外部接口
    ICache[&quot;ICache/MMU&quot;] &lt;--&gt;|&quot;icache_rd_o&lt;br/&gt;icache_pc_o[31:0]&lt;br/&gt;icache_inst_
i[63:0]&lt;br/&gt;icache_valid_i&lt;br/&gt;icache_accept_i&quot;| Fetch

    style NPC fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    style Fetch fill:#b2dfdb,stroke:#00695c,stroke-width:3px
    style Decode fill:#bbdefb,stroke:#0d47a1,stroke-width:3px
    style Out0 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style Out1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style ICache fill:#e1bee7,stroke:#6a1b9a,stroke-width:2px
    style Branch fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style BranchInfo fill:#ffccbc,stroke:#bf360c,stroke-width:2px
</code></pre>
<p>前端数据通路说明：</p>
<ul>
<li>PC 流向：NPC → next_pc_f_w → Fetch → icache_pc_o → ICache</li>
<li>指令流向：ICache → icache_inst_i[63:0] → Fetch → fetch_instr_w[63:0] → Decode → fetch0&#x2F;1_instr_o[31:0]</li>
<li>分支预测：NPC 产生预测信息 (next_taken_f_w) → Fetch → Decode</li>
<li>分支更新：执行单元分支结果 → branch_info_* → NPC 更新预测器</li>
<li>双发射输出：Decode 输出两路指令流 (fetch0&#x2F;fetch1) 到后端</li>
</ul>
<h3 id="reset-pc"><a href="#reset-pc" class="headerlink" title="reset_pc"></a>reset_pc</h3><p>reset_pc 这个信号很关键，它是 reset 之后 CPU 的初始 pc。查看源码可以看到，这个 PC 可以配置，也可以通过仿真环境往里面传入，testbench.h：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MEM_BASE 0x80000000</span><br>    <span class="hljs-comment">// Set reset vector</span><br>    reset_vector_in.<span class="hljs-built_in">write</span>(MEM_BASE);<br></code></pre></td></tr></table></figure>

<p>这个信号传送到 riscv_core –&gt; biriscv_csr：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (reset_q)<br><span class="hljs-keyword">begin</span><br>    branch_target_q &lt;= reset_vector_i;<br>    branch_q        &lt;= <span class="hljs-number">1&#x27;b1</span>;<br>    reset_q         &lt;= <span class="hljs-number">1&#x27;b0</span>;<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">begin</span><br>    branch_q        &lt;= csr_branch_w;<br>    branch_target_q &lt;= csr_target_w;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">assign</span> branch_csr_request_o = branch_q;<br><span class="hljs-keyword">assign</span> branch_csr_pc_o      = branch_target_q;<br><span class="hljs-keyword">assign</span> branch_csr_priv_o    = satp_reg_w[`SATP_MODE_R] ? current_priv_w : `PRIV_MACHINE;<br></code></pre></td></tr></table></figure>
<p>接着这个信号传递到了 issue：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">always</span> @ (<span class="hljs-keyword">posedge</span> clk_i <span class="hljs-keyword">or</span> <span class="hljs-keyword">posedge</span> rst_i)<br><span class="hljs-keyword">if</span> (rst_i)<br>    pc_x_q &lt;= <span class="hljs-number">32&#x27;b0</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (branch_csr_request_i)<br>    pc_x_q &lt;= branch_csr_pc_i;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (branch_d_exec1_request_i)<br>    pc_x_q &lt;= branch_d_exec1_pc_i;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (branch_d_exec0_request_i)<br>    pc_x_q &lt;= branch_d_exec0_pc_i;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dual_issue_w)<br>    pc_x_q &lt;= pc_x_q + <span class="hljs-number">32&#x27;d8</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (single_issue_w)<br>    pc_x_q &lt;= pc_x_q + <span class="hljs-number">32&#x27;d4</span>;<br></code></pre></td></tr></table></figure>

<p>reset 结束后的一个周期，branch_csr_request_i 拉高，pc_x_q 就是 传入的 reset_pc。</p>
<p>接着 issue 会发射这组信号发送到前端 frontend：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-comment">// Branch request (CSR branch - ecall, xret, or branch misprediction)</span><br><span class="hljs-comment">// Note: Correctly predicted branches are silent</span><br><span class="hljs-keyword">assign</span> branch_request_o          = branch_csr_request_i | mispredicted_r;<br><span class="hljs-keyword">assign</span> branch_pc_o               = branch_csr_request_i ? branch_csr_pc_i : pc_x_q;<br><span class="hljs-keyword">assign</span> branch_priv_o             = branch_csr_request_i ? branch_csr_priv_i : priv_x_q;<br></code></pre></td></tr></table></figure>

<p>frontend 拿到这组信号后，发射到 decode 和 biriscv_fetch。</p>
<p>decode 拿到 branch_request_i 之后，传给了 fetch_fifo 的 flush，目的是刷掉 fifo，其它两组信号悬空，没被利用。</p>
<p>biriscv_fetch 拿到信号后，传给关建的三个信号：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">generate</span><br><span class="hljs-keyword">if</span> (SUPPORT_MMU)<br><span class="hljs-keyword">begin</span><br>    <span class="hljs-keyword">assign</span> branch_w      = branch_q;<br>    <span class="hljs-keyword">assign</span> branch_pc_w   = branch_pc_q;<br>    <span class="hljs-keyword">assign</span> branch_priv_w = branch_priv_q;<br><br>    <span class="hljs-keyword">always</span> @ (<span class="hljs-keyword">posedge</span> clk_i <span class="hljs-keyword">or</span> <span class="hljs-keyword">posedge</span> rst_i)<br>    <span class="hljs-keyword">if</span> (rst_i)<br>    <span class="hljs-keyword">begin</span><br>        branch_q       &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>        branch_pc_q    &lt;= <span class="hljs-number">32&#x27;b0</span>;<br>        branch_priv_q  &lt;= `PRIV_MACHINE;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (branch_request_i)<br>    <span class="hljs-keyword">begin</span><br>        branch_q       &lt;= <span class="hljs-number">1&#x27;b1</span>; <span class="hljs-comment">// key sigs</span><br>        branch_pc_q    &lt;= branch_pc_i;<br>        branch_priv_q  &lt;= branch_priv_i;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (icache_rd_o &amp;&amp; icache_accept_i)<br>    <span class="hljs-keyword">begin</span><br>        branch_q       &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>        branch_pc_q    &lt;= <span class="hljs-number">32&#x27;b0</span>;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>做一些处理后传给 <code>frontend</code> ，然后传给 <code>MMU</code>，biriscv_fetch：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-comment">// Outputs</span><br><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-keyword">assign</span> icache_rd_o         = active_q &amp; fetch_accept_i &amp; !icache_busy_w;<br><span class="hljs-keyword">assign</span> icache_pc_o         = &#123;icache_pc_w[<span class="hljs-number">31</span>:<span class="hljs-number">3</span>],<span class="hljs-number">3&#x27;b0</span>&#125;;<br><span class="hljs-keyword">assign</span> icache_priv_o       = icache_priv_w;<br><span class="hljs-keyword">assign</span> icache_flush_o      = fetch_invalidate_i | icache_invalidate_q;<br><span class="hljs-keyword">assign</span> icache_invalidate_o = <span class="hljs-number">1&#x27;b0</span>;<br><br><span class="hljs-keyword">assign</span> icache_busy_w       =  icache_fetch_q &amp;&amp; !icache_valid_i;<br><br></code></pre></td></tr></table></figure>

<p>同时，<code>assign pc_f_o = icache_pc_w</code> 将信号发射到 biriscv_npc，下一个周期 npc 也将会给出 next_pc:</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-comment">// PC</span><br><span class="hljs-comment">//-------------------------------------------------------------</span><br><span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  pc_f_q;<br><span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  pc_d_q;<br><span class="hljs-keyword">reg</span> [<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]   pred_d_q;<br><br><span class="hljs-keyword">always</span> @ (<span class="hljs-keyword">posedge</span> clk_i <span class="hljs-keyword">or</span> <span class="hljs-keyword">posedge</span> rst_i)<br><span class="hljs-keyword">if</span> (rst_i)<br>    pc_f_q  &lt;= <span class="hljs-number">32&#x27;b0</span>;<br><span class="hljs-comment">// Branch request</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SUPPORT_MMU &amp;&amp; branch_w &amp;&amp; ~stall_w)<br>    pc_f_q  &lt;= branch_pc_w; <span class="hljs-comment">// reset 拿到 branch_pc_w</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!SUPPORT_MMU &amp;&amp; (stall_w || !active_q || stall_q) &amp;&amp; branch_w)<br>    pc_f_q  &lt;= branch_pc_w;<br><span class="hljs-comment">// NPC</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!stall_w)<br>    pc_f_q  &lt;= next_pc_f_i; <span class="hljs-comment">// 之后拿到 npc 传来的 next_pc_f_i</span><br></code></pre></td></tr></table></figure>

<h2 id="后端：忽略"><a href="#后端：忽略" class="headerlink" title="后端：忽略"></a>后端：忽略</h2><h2 id="新的思路"><a href="#新的思路" class="headerlink" title="新的思路"></a>新的思路</h2><p>通过前面的分析，现在基本掌握了 briscv frontend 的基本面貌。再次研究一下关于前端以及和前端有关单元的细节，以便于确定最好的思路。</p>
<h3 id="biriscv-npc-1"><a href="#biriscv-npc-1" class="headerlink" title="biriscv_npc"></a>biriscv_npc</h3><p>给 fetch 单元发射 next_pc，同时也收到 issue 反馈信息以修正分支预测器。</p>
<h3 id="biriscv-fetch-1"><a href="#biriscv-fetch-1" class="headerlink" title="biriscv_fetch"></a>biriscv_fetch</h3><p>在 reset 之后，fetch 单元固定向 npc 请求 next_pc。同时，biriscv_fetch 拿到 next_pc 之后，就以这个 pc 访问 icache&#x2F;mmu，获取指令字。</p>
<h3 id="biriscv-decode-1"><a href="#biriscv-decode-1" class="headerlink" title="biriscv_decode"></a>biriscv_decode</h3><p>decode 拿到指令字之后，就开始解码，这里是组合电路，因此可以抓取 <code>pc:inst</code>进行检验。在 decode 中实例化了两个 decoder 单元，它们负责解析指令类型，比如：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">assign</span> branch_o =   ((opcode_i &amp; `INST_JAL_MASK) == `INST_JAL)   ||<br>                    ((opcode_i &amp; `INST_JALR_MASK) == `INST_JALR) ||<br>                    ((opcode_i &amp; `INST_BEQ_MASK) == `INST_BEQ)   ||<br>                    ((opcode_i &amp; `INST_BNE_MASK) == `INST_BNE)   ||<br>                    ((opcode_i &amp; `INST_BLT_MASK) == `INST_BLT)   ||<br>                    ((opcode_i &amp; `INST_BGE_MASK) == `INST_BGE)   ||<br>                    ((opcode_i &amp; `INST_BLTU_MASK) == `INST_BLTU) ||<br>                    ((opcode_i &amp; `INST_BGEU_MASK) == `INST_BGEU);<br></code></pre></td></tr></table></figure>


<h3 id="biriscv-issue"><a href="#biriscv-issue" class="headerlink" title="biriscv_issue"></a>biriscv_issue</h3><p>拿到 decode 发来的数据后，这里就可以发送到执行单元了。同时，这里会给 <code>biriscv_npc</code> 发送反馈信息以更新 <code>btb</code> 或者强化 <code>bht</code>。</p>
<h3 id="观察波形图"><a href="#观察波形图" class="headerlink" title="观察波形图"></a>观察波形图</h3><p>这是双发射架构，因此先研究一个发射单元的数据通路。</p>
<h3 id="exec0"><a href="#exec0" class="headerlink" title="exec0"></a>exec0</h3><p>exec0 &lt;—&gt; issue。来自 issue 发射单元的一组输入信号：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Verilog">,<span class="hljs-keyword">input</span>           opcode_valid_i<br>,<span class="hljs-keyword">input</span>  [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  opcode_opcode_i<br>,<span class="hljs-keyword">input</span>  [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  opcode_pc_i<br>,<span class="hljs-keyword">input</span>           opcode_invalid_i<br>,<span class="hljs-keyword">input</span>  [  <span class="hljs-number">4</span>:<span class="hljs-number">0</span>]  opcode_rd_idx_i<br>,<span class="hljs-keyword">input</span>  [  <span class="hljs-number">4</span>:<span class="hljs-number">0</span>]  opcode_ra_idx_i<br>,<span class="hljs-keyword">input</span>  [  <span class="hljs-number">4</span>:<span class="hljs-number">0</span>]  opcode_rb_idx_i<br>,<span class="hljs-keyword">input</span>  [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  opcode_ra_operand_i<br>,<span class="hljs-keyword">input</span>  [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  opcode_rb_operand_i<br>,<span class="hljs-keyword">input</span>           hold_i<br></code></pre></td></tr></table></figure>

<p>其中关键的信号是 <code>opcode_pc_i</code>，<code>opcode_opcode_i</code>。前者是当前 exec0 正在处理的指令的 pc，后者是经过 decode 处理后的译码信息。</p>
<p>完成计算的同时（后）它输出了一组关键的信息用来反馈前端：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Verilog">,<span class="hljs-keyword">output</span>          branch_request_o<br>,<span class="hljs-keyword">output</span>          branch_is_taken_o<br>,<span class="hljs-keyword">output</span>          branch_is_not_taken_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_source_o<br>,<span class="hljs-keyword">output</span>          branch_is_call_o<br>,<span class="hljs-keyword">output</span>          branch_is_ret_o<br>,<span class="hljs-keyword">output</span>          branch_is_jmp_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_pc_o<br>,<span class="hljs-keyword">output</span>          branch_d_request_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_d_pc_o<br>,<span class="hljs-keyword">output</span> [  <span class="hljs-number">1</span>:<span class="hljs-number">0</span>]  branch_d_priv_o<br></code></pre></td></tr></table></figure>

<p>其中以下信息将会延迟一拍返回 issue：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Verilog">,<span class="hljs-keyword">output</span>          branch_request_o<br>,<span class="hljs-keyword">output</span>          branch_is_taken_o<br>,<span class="hljs-keyword">output</span>          branch_is_not_taken_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_source_o<br>,<span class="hljs-keyword">output</span>          branch_is_call_o<br>,<span class="hljs-keyword">output</span>          branch_is_ret_o<br>,<span class="hljs-keyword">output</span>          branch_is_jmp_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_pc_o<br></code></pre></td></tr></table></figure>

<p>而这组信号是组合电路产生的，会在本周期内返回 issue：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Verilog">,<span class="hljs-keyword">output</span>          branch_d_request_o<br>,<span class="hljs-keyword">output</span> [ <span class="hljs-number">31</span>:<span class="hljs-number">0</span>]  branch_d_pc_o<br>,<span class="hljs-keyword">output</span> [  <span class="hljs-number">1</span>:<span class="hljs-number">0</span>]  branch_d_priv_o<br></code></pre></td></tr></table></figure>

<h3 id="issue"><a href="#issue" class="headerlink" title="issue"></a>issue</h3><p>issue 单元会将以下信息发往到 frontend–&gt;npc：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">assign</span> branch_info_request_o      = mispredicted_r;<br><span class="hljs-keyword">assign</span> branch_info_is_taken_o     = (pipe1_branch_e1_w &amp; branch_exec1_is_taken_i)     | (pipe0_branch_e1_w &amp; branch_exec0_is_taken_i);<br><span class="hljs-keyword">assign</span> branch_info_is_not_taken_o = (pipe1_branch_e1_w &amp; branch_exec1_is_not_taken_i) | (pipe0_branch_e1_w &amp; branch_exec0_is_not_taken_i);<br><span class="hljs-keyword">assign</span> branch_info_is_call_o      = (pipe1_branch_e1_w &amp; branch_exec1_is_call_i)      | (pipe0_branch_e1_w &amp; branch_exec0_is_call_i);<br><span class="hljs-keyword">assign</span> branch_info_is_ret_o       = (pipe1_branch_e1_w &amp; branch_exec1_is_ret_i)       | (pipe0_branch_e1_w &amp; branch_exec0_is_ret_i);<br><span class="hljs-keyword">assign</span> branch_info_is_jmp_o       = (pipe1_branch_e1_w &amp; branch_exec1_is_jmp_i)       | (pipe0_branch_e1_w &amp; branch_exec0_is_jmp_i);<br><span class="hljs-keyword">assign</span> branch_info_source_o       = (pipe1_branch_e1_w &amp; branch_exec1_request_i)      ? branch_exec1_source_i : branch_exec0_source_i;<br><span class="hljs-keyword">assign</span> branch_info_pc_o           = (pipe1_branch_e1_w &amp; branch_exec1_request_i)      ? branch_exec1_pc_i     : branch_exec0_pc_i;<br></code></pre></td></tr></table></figure>

<p>npc 在下一个周期就会完成 BTB、BHT 的更新。</p>
<p>同时 issue 将这个分支信息发送到 decode、fetch 单元。</p>
<h3 id="分支预测器的性能表现"><a href="#分支预测器的性能表现" class="headerlink" title="分支预测器的性能表现"></a>分支预测器的性能表现</h3><p>首先，当 npc 中的 branch_request_i 的信号拉高的时候，确实是执行单元拿到了不期待的指令。通过观察波形图，当它拉高的时候，有可能是非分支指令。但是当 branch_request_i 拉高的时候，branch_is_taken_i 或者 branch_is_not_taken_i 拉高，那么一定是分支指令出现了跳转错误。</p>
<p>因此，有一个思路是，统计所有的分支指令和 <code>(branch_request_i &amp;&amp; (branch_is_taken_i || branch_is_not_taken_i)</code> 的次数，这就能判断出分支指令预测的准确率。</p>
<p>所有的分支指令如何统计？只需要将 branch_is_taken_i 和 branch_is_not_taken_i 数据加起来就行了，就这么简单。</p>
<p>最终的结果令人满意（方向、目标正确率暂未实现，整体正确率才有意义）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs txt">========================================<br>   Branch Predictor Statistics<br>========================================<br><br>--- Overall Statistics ---<br>Total Branches:      5560<br>Total Predictions:   5560<br><br>--- Direction Prediction ---<br>Correct:             5015<br>Incorrect:           545<br>Accuracy:            90.20%<br><br>--- Target Address Prediction ---<br>Correct:             5015<br>Incorrect:           545<br>Accuracy:            90.20%<br><br>--- Overall Prediction (Direction + Target) ---<br>Correct:             5015<br>Incorrect:           545<br>Accuracy:            90.20%<br><br>--- Branch Type Distribution ---<br>Taken:               3596<br>Not Taken:           1964<br>Calls:               37<br>Returns:             1<br>Jumps:               189<br>========================================<br></code></pre></td></tr></table></figure>




















                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" class="category-chain-item">计算机体系结构</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/" class="print-no-link">#分支预测</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>biriscv_npc 性能分析</div>
      <div>http://blog.luliang.online/2025/11/18/分支预测器2/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Luyoung</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年11月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/26/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A83/" title="预测器关键参数">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">预测器关键参数</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/17/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A81/" title="biriscv_npc 分析">
                        <span class="hidden-mobile">biriscv_npc 分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
