

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://raw.githubusercontent.com/Luyoung0001/picBed/main/low.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Luyoung">
  <meta name="keywords" content="">
  
    <meta name="description" content="loopThe Loop Predictor specializes in predicting loop exit branches.It learns the iteration count of loops and predicts the loop exit when the learned count is reached. Structure:  Small table (16 set">
<meta property="og:type" content="article">
<meta property="og:title" content="riscv-boom&#39;s loop">
<meta property="og:url" content="http://blog.luliang.online/2025/12/02/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A8loop/index.html">
<meta property="og:site_name" content="Luyoung">
<meta property="og:description" content="loopThe Loop Predictor specializes in predicting loop exit branches.It learns the iteration count of loops and predicts the loop exit when the learned count is reached. Structure:  Small table (16 set">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-12-02T07:03:16.000Z">
<meta property="article:modified_time" content="2026-01-24T09:00:40.451Z">
<meta property="article:author" content="Luyoung">
<meta property="article:tag" content="分支预测">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>riscv-boom&#39;s loop - Luyoung</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.luliang.online","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 65vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Luyoung</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/Luyoung0001/picBed/main/1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="riscv-boom&#39;s loop"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-02 15:03" pubdate>
          2025年12月2日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          29 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">riscv-boom&#39;s loop</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><p>The Loop Predictor specializes in predicting loop exit branches.It learns the iteration count of loops and predicts the loop exit when the learned count is reached.</p>
<p>Structure:</p>
<ul>
<li>Small table (16 sets by default)</li>
<li>Each entry stores: tag, confidence, age, predicted count, speculative count</li>
<li>When speculative count matches predicted count with high confidence,<br>predict the opposite of the base predictor (i.e., exit the loop)</li>
</ul>
<p>Update Policy:</p>
<ul>
<li>On misprediction at loop exit: update predicted count, adjust confidence</li>
<li>Age-based replacement for conflicting entries</li>
</ul>
<h2 id="Loop-Predictor"><a href="#Loop-Predictor" class="headerlink" title="Loop Predictor"></a>Loop Predictor</h2><h2 id="功能定位"><a href="#功能定位" class="headerlink" title="功能定位"></a>功能定位</h2><ul>
<li>检测<strong>固定次数的循环</strong></li>
<li>纠正TAGE对循环边界的预测</li>
<li>处理<code>for(i=0; i&lt;N; i++)</code>这类模式</li>
</ul>
<h2 id="核心问题"><a href="#核心问题" class="headerlink" title="核心问题"></a>核心问题</h2><p>TAGE的限制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">99</span>) &#123;  <span class="hljs-comment">// 这个分支</span><br>        <span class="hljs-comment">// taken 99次</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// not taken 1次</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TAGE看到的历史：<code>TTTTTTT...TTTN</code>（99个T，1个N）</p>
<ul>
<li>历史中99%是T，TAGE会强烈偏向Taken</li>
<li>在第100次（应该Not Taken）时，TAGE可能预测错误</li>
</ul>
<p>Loop预测器的作用：</p>
<ul>
<li>记住”这个分支每100次循环后会Not Taken”</li>
<li>在第100次时反转TAGE的预测</li>
</ul>
<h2 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h2><p><strong>表项定义</strong>（loop.scala:31-37）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoopEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> tag   = <span class="hljs-type">UInt</span>(<span class="hljs-number">10.</span><span class="hljs-type">W</span>)   <span class="hljs-comment">// PC标签</span><br>  <span class="hljs-keyword">val</span> conf  = <span class="hljs-type">UInt</span>(<span class="hljs-number">3.</span><span class="hljs-type">W</span>)    <span class="hljs-comment">// 置信度（0-7）</span><br>  <span class="hljs-keyword">val</span> age   = <span class="hljs-type">UInt</span>(<span class="hljs-number">3.</span><span class="hljs-type">W</span>)    <span class="hljs-comment">// 年龄（用于替换）</span><br>  <span class="hljs-keyword">val</span> p_cnt = <span class="hljs-type">UInt</span>(<span class="hljs-number">10.</span><span class="hljs-type">W</span>)   <span class="hljs-comment">// 预测的循环次数（0-1023）</span><br>  <span class="hljs-keyword">val</span> s_cnt = <span class="hljs-type">UInt</span>(<span class="hljs-number">10.</span><span class="hljs-type">W</span>)   <span class="hljs-comment">// 当前循环计数（0-1023）</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>组织结构</strong>：</p>
<ul>
<li>16个sets，每个set有多列（way）</li>
<li>全相联查找（在每个set内）</li>
</ul>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p><strong>预测阶段</strong>（loop.scala:81-85）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// 默认：使用前一级预测器的结果</span><br>io.f3_pred := io.f3_pred_in<br><br><span class="hljs-comment">// 检查是否命中循环表</span><br>when (entry.tag === current_tag) &#123;<br>  <span class="hljs-comment">// 检查是否到达循环边界</span><br>  when (s_cnt === entry.p_cnt &amp;&amp; entry.conf === <span class="hljs-number">7.</span><span class="hljs-type">U</span>) &#123;<br>    <span class="hljs-comment">// 反转预测！</span><br>    io.f3_pred := !io.f3_pred_in<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>更新逻辑</strong>（loop.scala:95-106）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// F4阶段（预测后的下一个cycle）</span><br>when (f4_fire &amp;&amp; entry.tag === tag) &#123;<br>  when (f4_scnt === entry.p_cnt &amp;&amp; entry.conf === <span class="hljs-number">7.</span><span class="hljs-type">U</span>) &#123;<br>    <span class="hljs-comment">// 检测到循环边界，重置计数器</span><br>    entries(idx).s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>    entries(idx).age   := <span class="hljs-number">7.</span><span class="hljs-type">U</span><br>  &#125; .otherwise &#123;<br>    <span class="hljs-comment">// 循环内部，递增计数器</span><br>    entries(idx).s_cnt := f4_scnt + <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    entries(idx).age   := <span class="hljs-type">Mux</span>(age === <span class="hljs-number">7.</span><span class="hljs-type">U</span>, <span class="hljs-number">7.</span><span class="hljs-type">U</span>, age + <span class="hljs-number">1.</span><span class="hljs-type">U</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>预测错误时的学习</strong>（loop.scala:114-167）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs scala">when (mispredict &amp;&amp; !doing_reset) &#123;<br>  <span class="hljs-keyword">val</span> entry = entries(update_idx)<br>  <span class="hljs-keyword">val</span> tag_match = entry.tag === update_tag<br>  <span class="hljs-keyword">val</span> ctr_match = entry.p_cnt === update_scnt<br><br>  when (entry.conf === <span class="hljs-number">7.</span><span class="hljs-type">U</span> &amp;&amp; tag_match) &#123;<br>    <span class="hljs-comment">// 已学习，但预测错误 → 降低置信度</span><br>    wentry.conf := entry.conf - <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><br>  &#125; .elsewhen (entry.conf === <span class="hljs-number">7.</span><span class="hljs-type">U</span> &amp;&amp; !tag_match) &#123;<br>    <span class="hljs-comment">// 已学习，但tag不匹配 → 不做替换（保护高置信度entry）</span><br><br>  &#125; .elsewhen (entry.conf =/= <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; tag_match &amp;&amp; ctr_match) &#123;<br>    <span class="hljs-comment">// 学习中，计数匹配 → 增加置信度</span><br>    wentry.conf := entry.conf + <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><br>  &#125; .elsewhen (entry.conf =/= <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; tag_match &amp;&amp; !ctr_match) &#123;<br>    <span class="hljs-comment">// 学习中，计数不匹配 → 重新学习</span><br>    wentry.conf := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>    wentry.p_cnt := update_scnt  <span class="hljs-comment">// 更新预期循环次数</span><br>    wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><br>  &#125; .elsewhen (entry.conf =/= <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; !tag_match &amp;&amp; entry.age === <span class="hljs-number">0.</span><span class="hljs-type">U</span>) &#123;<br>    <span class="hljs-comment">// 学习中，tag不匹配，age低 → 替换</span><br>    wentry.tag := update_tag<br>    wentry.conf := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    wentry.p_cnt := update_scnt<br>    wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><br>  &#125; .elsewhen (entry.conf =/= <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; !tag_match &amp;&amp; entry.age =/= <span class="hljs-number">0.</span><span class="hljs-type">U</span>) &#123;<br>    <span class="hljs-comment">// 学习中，tag不匹配，age高 → 降低age</span><br>    wentry.age := entry.age - <span class="hljs-number">1.</span><span class="hljs-type">U</span><br><br>  &#125; .elsewhen (entry.conf === <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; tag_match) &#123;<br>    <span class="hljs-comment">// 未初始化，tag匹配</span><br>    when (ctr_match) &#123;<br>      wentry.conf := <span class="hljs-number">1.</span><span class="hljs-type">U</span>  <span class="hljs-comment">// 开始学习</span><br>      wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>    &#125; .otherwise &#123;<br>      wentry.p_cnt := update_scnt  <span class="hljs-comment">// 记录循环次数</span><br>      wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>    &#125;<br><br>  &#125; .elsewhen (entry.conf === <span class="hljs-number">0.</span><span class="hljs-type">U</span> &amp;&amp; !tag_match) &#123;<br>    <span class="hljs-comment">// 未初始化，分配新entry</span><br>    wentry.tag := update_tag<br>    wentry.conf := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    wentry.p_cnt := update_scnt<br>    wentry.s_cnt := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h2><p>Loop entry的学习过程：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[<span class="hljs-attribute">conf</span>=0, 未初始化]<br>         ↓ 第一次预测错误，记录循环次数N<br>[<span class="hljs-attribute">conf</span>=1, 学习中, <span class="hljs-attribute">p_cnt</span>=N]<br>         ↓ 再次在第N次时预测错误<br>[<span class="hljs-attribute">conf</span>=2, 学习中]<br>         ↓ 持续匹配<br>      <span class="hljs-built_in">..</span>.<br>         ↓<br>[<span class="hljs-attribute">conf</span>=7, 已学习] ← 开始生效，反转预测<br>         ↓ 如果再次错误<br>[<span class="hljs-attribute">conf</span>=6, 降低置信度]<br></code></pre></td></tr></table></figure>

<h2 id="为什么有效"><a href="#为什么有效" class="headerlink" title="为什么有效"></a>为什么有效</h2><p><strong>例子</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">99</span>) &#123; ... &#125;  <span class="hljs-comment">// 分支A</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>TAGE的视角</strong>：</p>
<ul>
<li>历史：<code>TTTTTT...TTTTN</code>（99个T，1个N）</li>
<li>预测：总是Taken（因为99%历史是T）</li>
<li>第100次：预测Taken，实际Not Taken → <strong>错误</strong></li>
</ul>
<p><strong>Loop的视角</strong>：</p>
<ul>
<li>记录：这个分支每100次有一个边界</li>
<li>s_cnt: 0→1→2→…→99</li>
<li>当s_cnt&#x3D;99时：检测到边界，反转TAGE的预测</li>
<li>预测：Not Taken → <strong>正确</strong></li>
</ul>
<hr>
<h2 id="预测器的组合逻辑级联"><a href="#预测器的组合逻辑级联" class="headerlink" title="预测器的组合逻辑级联"></a>预测器的组合逻辑级联</h2><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>所有预测器的连接（config-mixins.scala:603-609）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// 初始输入（全0预测）</span><br><span class="hljs-keyword">val</span> resp_in = (<span class="hljs-number">0.</span><span class="hljs-type">U</span>).asTypeOf(<span class="hljs-keyword">new</span> <span class="hljs-type">BranchPredictionBankResponse</span>)<br><br><span class="hljs-comment">// 组合逻辑链</span><br>ubtb.io.resp_in(<span class="hljs-number">0</span>)  := resp_in<br>bim.io.resp_in(<span class="hljs-number">0</span>)   := ubtb.io.resp      <span class="hljs-comment">// 组合逻辑</span><br>btb.io.resp_in(<span class="hljs-number">0</span>)   := bim.io.resp       <span class="hljs-comment">// 组合逻辑</span><br>tage.io.resp_in(<span class="hljs-number">0</span>)  := btb.io.resp       <span class="hljs-comment">// 组合逻辑</span><br>loop.io.resp_in(<span class="hljs-number">0</span>)  := tage.io.resp      <span class="hljs-comment">// 组合逻辑</span><br><br><span class="hljs-comment">// 最终输出</span><br>final_resp = loop.io.resp<br></code></pre></td></tr></table></figure>

<h2 id="Loop-Predictor-循环预测器工作流程详解"><a href="#Loop-Predictor-循环预测器工作流程详解" class="headerlink" title="Loop Predictor 循环预测器工作流程详解"></a>Loop Predictor 循环预测器工作流程详解</h2><h3 id="1-整体架构概览"><a href="#1-整体架构概览" class="headerlink" title="1. 整体架构概览"></a>1. 整体架构概览</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌──────────────────────────────────────────────────────────────────────────────────────────┐<br>│                              Loop Branch Predictor                                        │<br>│                                                                                           │<br>│  ┌─────────────────────────────────────────────────────────────────────────────────────┐ │<br>│  │                      多列结构 (bankWidth 个独立 Column)                              │ │<br>│  │                                                                                      │ │<br>│  │   Column 0           Column 1           Column 2          ...      Column N-1       │ │<br>│  │  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐         ┌──────────────┐   │ │<br>│  │  │  entries[16] │   │  entries[16] │   │  entries[16] │   ...   │  entries[16] │   │ │<br>│  │  │              │   │              │   │              │         │              │   │ │<br>│  │  │  LoopEntry   │   │  LoopEntry   │   │  LoopEntry   │         │  LoopEntry   │   │ │<br>│  │  │  寄存器阵列   │   │  寄存器阵列   │   │  寄存器阵列   │         │  寄存器阵列   │   │ │<br>│  │  └──────────────┘   └──────────────┘   └──────────────┘         └──────────────┘   │ │<br>│  │         │                  │                  │                        │           │ │<br>│  │         └───────────���──────┴──────────────────┴────────────────────────┘           │ │<br>│  │                                         │                                           │ │<br>│  │                                         ▼                                           │ │<br>│  │                              ┌─────────────────────┐                                │ │<br>│  │                              │   Loop 覆盖逻辑     │                                │ │<br>│  │                              │ (高置信度时翻转预测) │                                │ │<br>│  │                              └─────────────────────┘                                │ │<br>│  └─────────────────────────────────────────────────────────────────────────────────────┘ │<br>│                                                                                           │<br>│  基础预测器: io.resp_in(0) 提供初始预测 (通常来自 TAGE/BIM)                               │<br>│  Loop 预测器: 在检测到稳定循环模式时覆盖基础预测                                           │<br>└─────────────────────────────────────��────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>
<h3 id="2-数据结构详解"><a href="#2-数据结构详解" class="headerlink" title="2. 数据结构详解"></a>2. 数据结构详解</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                           LoopEntry (循环条目)                                   │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>┌────────────────────────────────────���────────────────────────────────────────────┐<br>│                           LoopEntry Bundle                                       │<br>├────────────┬────────────┬────────────┬────────────┬────────────────────────────┤<br>│  tag (10b) │  conf (3b) │  age (3b)  │ p_cnt (10b)│        s_cnt (10b)         │<br>│  地址标签   │  置信度    │  年龄计数  │ 预测循环次数│        当前迭代次数         │<br>└────────────┴────────────┴────────────┴────────────┴────────────────────────────┘<br><br>字段详解:<br>┌────────────┬───────────────────────────────────────────────────────────────────┐<br>│    tag     │ 分支地址的高位标签，用于匹配检查                                    │<br>│            │ 范围: 10 bits                                                      │<br>├────────────┼────────────────────────────────────────────────────────────────��──┤<br>│    conf    │ 置信度计数器 (0-7)                                                 │<br>│            │ conf = 7: 完全学习，可以进行预测覆盖                                │<br>│            │ conf = 0: 未学习/不确定                                            │<br>├────────────┼───────────────────────────────────────────────────────────────────┤<br>│    age     │ 年龄计数器 (0-7)，用于替换策略                                      │<br>│            │ age = 0: 可被替换                                                  │<br>│            │ age = 7: 最近活跃，不应被替换                                       │<br>├────────────┼───────────────────────────────────────────────────────────────────┤<br>│   p_cnt    │ 预测的循环次数 (Predicted Count)                                   │<br>│            │ 记录学习到的循环迭代次数                                            │<br>│            │ 范围: 0-1023 (10 bits)                                             │<br>├────────────┼───────────────────────────────────────────────────────────────────┤<br>│   s_cnt    │ 推测执行计数 (Speculative Count)                                   │<br>│            │ 当前循环已执行的迭代次数                                            │<br>│            │ 当 s_cnt == p_cnt 时，预测循环结束                                  │<br>└────────────┴───────────────────────────────────────────────────────────────────┘<br><br><br>LoopMeta (预测元数据):<br>┌───────��──────────────────────────────────────────────────────────────���──────────┐<br>│                           LoopMeta Bundle                                        │<br>├─────────────────────────────────────────────────────────────────────────────────┤<br>│                         s_cnt (10 bits)                                          │<br>│                     记录预测时的推测计数值                                        │<br>│                     用于误预测恢复时修复状态                                      │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>
<h3 id="3-循环预测核心原理"><a href="#3-循环预测核心原理" class="headerlink" title="3. 循环预测核心原理"></a>3. 循环预测核心原理</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                        循环预测原理                                              │<br>└──────────────────────────────��──────────────────────────────────────────────────┘<br><br>典型循环代码:<br>    for (int i = 0; i &lt; 100; i++) &#123;<br>        // loop body<br>    &#125;<br><br>对应的分支行为:<br>    迭代 0:   Taken  (继续循环)<br>    迭代 1:   Taken  (继续循环)<br>    ...<br>    迭代 98:  Taken  (继续循环)<br>    迭代 99:  Not Taken (退出循环)  ← 这是关键点!<br><br>问题: 传统预测器 (BIM/TAGE) 难以预测最后一次退出<br>     因为前 99 次都是 Taken，会训练计数器趋向 Taken<br><br>Loop Predictor 解决方案:<br>    1. 学习循环的精确次数 (p_cnt = 100)<br>    2. 跟踪当前迭代 (s_cnt = 0, 1, 2, ... 99)<br>    3. 当 s_cnt == p_cnt 时，预测 Not Taken (覆盖基础预测器)<br><br>    迭代:     0     1     2    ...   98    99<br>              │     │     │          │     │<br>    s_cnt:    0     1     2    ...   98    99<br>              │     │     │          │     │<br>    p_cnt:   100   100   100   ...  100   100<br>              │     │     │          │     │<br>    匹配?:   No    No    No    ...  No    Yes!<br>              │     │     │          │     │<br>    动作:   透传   透传   透传  ...  透传  翻转!<br><br></code></pre></td></tr></table></figure>
<h3 id="4-置信度状态机"><a href="#4-置信度状态机" class="headerlink" title="4. 置信度状态机"></a>4. 置信度状态机</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                        置信度 (conf) 状态机                                      │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>                    置信度等级与行为<br>    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐<br>    │  0  │  1  │  2  │  3  │  4  │  5  │  6  │  7  │<br>    │未学 │ 低  │ 低  │ 中  │ 中  │ 高  │ 高  │完全 │<br>    │ 习  │置信 │置信 │置信 │置信 │置信 │置信 │学习 │<br>    └─────┴─────┴─────┴─��───┴─────┴─────┴─────┴─────┘<br>                                              │<br>                                              ▼<br>                                     只有 conf=7 时<br>                                     才会覆盖基础预测<br><br>状态转换:<br><br>    ┌──────────────────────────────────────────────────────────────────────────┐<br>    │                                                                           │<br>    │     新分支发现                 循环计数匹配              最终学习完成       │<br>    │         │                          │                        │            │<br>    │         ▼                          ▼                        ▼            │<br>    │     ┌───────┐  匹配且计数正确  ┌───────┐  匹配且计数正确  ┌───────┐       │<br>    │     │conf=0 │ ─────────────► │conf=1 │ ─────────────► │conf=7 │       │<br>    │     │ 未学习 │                │ 开始  │    ...         │ 完成  │       │<br>    │     └───────┘                └───────┘                └───────┘       │<br>    │         ▲                        │                        │            │<br>    │         │                        │ 计数不匹配              │ 误预测     │<br>    │         │                        ▼                        ▼            │<br>    │         │                   重置 p_cnt              conf = conf - 1    │<br>    │         │                   保持 conf                                   │<br>    │         │                                                               │<br>    │         └───────────────────────────────────────────────────────────────│<br>    │                          循环模式改变时完全重置                           │<br>    └──────────────────────────────────────────────────────────────────────────┘<br><br></code></pre></td></tr></table></figure>
<h3 id="5-预测流水线时序"><a href="#5-预测流水线时序" class="headerlink" title="5. 预测流水线时序"></a>5. 预测流水线时序</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌────────────────────────────────────────────────────────��────────────────────────┐<br>│                            预测流水线时序                                        │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>  周期     F2 (查找)        F3 (预测)         F4 (更新)<br>   │          │                │                 │<br>   ▼          ▼                ▼                 ▼<br> ─────────────────────────────────────────────────────────────────<br>   │                           │                 │<br>   │  ┌──────────────────┐     │                 │<br>   │  │ f2_req_valid     │     │                 │<br>   │  │ f2_req_idx       │     │                 │<br>   │  │                  │     │                 │<br>   │  │ 读取 entries     │─────│                 │<br>   │  │ f2_entry =       │ Reg │                 │<br>   │  │ entries(idx)     │     │                 │<br>   │  │                  │     │                 │<br>   │  │ 旁路检查:        │     │                 │<br>   │  │ repair/mispredict│     │                 │<br>   │  └──────────────────┘     │                 │<br>   │                           │                 │<br>   │                    ┌──────▼──────┐          │<br>   │                    │ f3_entry    │          │<br>   │                    │ f3_scnt     │          │<br>   │                    │ f3_tag      │          │<br>   │                    │             │          │<br>   │                    │ 标签匹配?   │          │<br>   │                    │ tag == f3_tag│         │<br>   │                    │             │          │<br>   │                    │ 预测条件:   │          │<br>   │                    │ s_cnt==p_cnt│          │<br>   │                    │ &amp;&amp; conf==7  │──────────│<br>   │                    │             │   Reg    │<br>   │                    │ 输出:       │          │<br>   │                    │ f3_pred     │          │<br>   │                    │ f3_meta     │          │<br>   │                    └─────────────┘          │<br>   │                                             │<br>   │                                     ┌───────▼───────┐<br>   │                                     │ f4_fire       │<br>   │                                     │ f4_entry      │<br>   │                                     │ f4_scnt       │<br>   │                                     │               │<br>   │                                     │ 更新 entries: │<br>   │                                     │ s_cnt++       │<br>   │                                     │ age 管理      │<br>   │                                     └───────────────┘<br> ─────────────────────────────────────────────────────────────────<br></code></pre></td></tr></table></figure>
<p>关键点:</p>
<ul>
<li>F2: 读取条目，处理旁路</li>
<li>F3: 标签匹配，做出预测决策</li>
<li>F4: 推测更新 s_cnt (在预测被使用后)</li>
</ul>
<h3 id="6-预测决策逻辑"><a href="#6-预测决策逻辑" class="headerlink" title="6. 预测决策逻辑"></a>6. 预测决策逻辑</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                         预测决策流程                                             │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>                         ┌─────────────────────────┐<br>                         │   f3_pred_in            │<br>                         │ (来自基础预测器的预测)   │<br>                         └────────────┬────────────┘<br>                                      │<br>                                      ▼<br>                         ┌─────────────────────────┐<br>                         │   f3_entry.tag == f3_tag?│<br>                         │   (标签匹配检查)         │<br>                         └────────────┬────────────┘<br>                                      │<br>                    ┌─────────────────┴─────────────────┐<br>                    │                                   │<br>                    ▼                                   ▼<br>              标签匹配                             标签不匹配<br>                    │                                   │<br>                    ▼                                   ▼<br>    ┌───────────────────────────────┐      ┌───────────────────────┐<br>    │  f3_scnt == f3_entry.p_cnt?   │      │  透传基础预测          │<br>    │  &amp;&amp; f3_entry.conf == 7?       │      │  f3_pred = f3_pred_in  │<br>    └───────────────┬───────────────┘      └───────────────────────┘<br>                    │<br>       ┌────────────┴────────────┐<br>       │                         │<br>       ▼                         ▼<br>    条件满足                  条件不满足<br>       │                         │<br>       ▼                         ▼<br>┌──────────────────┐    ┌──────────────────┐<br>│ 翻转预测!         │    │ 透传基础预测      │<br>│ f3_pred =        │    │ f3_pred =        │<br>│   !f3_pred_in    │    │   f3_pred_in     │<br>└──────────────────┘    └──────────────────┘<br><br><br>代码对应 (loop.scala:78-85):<br><br>    io.f3_pred := io.f3_pred_in    // 默认透传<br><br>    when (f3_entry.tag === f3_tag) &#123;<br>      when (f3_scnt === f3_entry.p_cnt &amp;&amp; f3_entry.conf === 7.U) &#123;<br>        io.f3_pred := !io.f3_pred_in    // 翻转!<br>      &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<h3 id="7-推测更新逻辑-F4-阶段"><a href="#7-推测更新逻辑-F4-阶段" class="headerlink" title="7. 推测更新逻辑 (F4 阶段)"></a>7. 推测更新逻辑 (F4 阶段)</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs txt">┌───────────────────────��─────────────────────────────────────────────────────────┐<br>│                         F4 推测更新                                              │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>目的: 在预测被前端使用后，更新循环计数器<br><br>触发条件: f4_fire (预测已发送且被采用)<br><br>                         ┌─────────────────────────┐<br>                         │       f4_fire           │<br>                         │   (预测被采用)           │<br>                         └────────────┬────────────┘<br>                                      │<br>                                      ▼<br>                         ┌─────────────────────────┐<br>                         │ f4_entry.tag == f4_tag? │<br>                         └────────────┬────────────┘<br>                                      │<br>                    ┌─────────────────┴─────────────────┐<br>                    │                                   │<br>                    ▼                                   ▼<br>              标签匹配                             标签不匹配<br>                    │                                   │<br>                    ▼                                   ▼<br>    ┌───────────────────────────────┐      ┌───────────────────────┐<br>    │  循环结束条件?                 │      │  不更新               │<br>    │  s_cnt == p_cnt &amp;&amp; conf == 7   │      │                       │<br>    └───────────────┬───────────────┘      └───────────────────────┘<br>                    │<br>       ┌────────────┴────────────┐<br>       │                         │<br>       ▼                         ▼<br>    循环结束                  循环继续<br>       │                         │<br>       ▼                         ▼<br>┌──────────────────┐    ┌────────────────────────┐<br>│ 重置计数器:       │    │ 递增计数器:             │<br>│ s_cnt = 0        │    │ s_cnt = s_cnt + 1      │<br>│ age = 7 (刷新)   │    │ age = min(age+1, 7)    │<br>└──────────────────┘    └────────────────────────┘<br><br><br>示例 (循环 100 次):<br><br>    迭代     s_cnt    p_cnt    动作<br>    ───────────────────────────────────<br>      0        0      100     s_cnt++ → 1<br>      1        1      100     s_cnt++ → 2<br>      2        2      100     s_cnt++ → 3<br>     ...      ...     ...     ...<br>     98       98      100     s_cnt++ → 99<br>     99       99      100     s_cnt++ → 100 ✗ 应该重置!<br>    ───────────────────────────────────<br><br>    等等，上面有问题！因为预测翻转发生在 s_cnt==p_cnt 时<br>    实际上:<br><br>    迭代     s_cnt    p_cnt    预测        动作<br>    ───────────────────────────────────────────────<br>      0        0      100     Taken       s_cnt++ → 1<br>     ...      ...     ...     ...         ...<br>     99       99      100     Taken       s_cnt++ → 100<br>    100      100      100     翻转→NT!    s_cnt = 0 (重置)<br>    ───────────────────────────────────────────────<br></code></pre></td></tr></table></figure>
<h3 id="8-误预测更新状态机"><a href="#8-误预测更新状态机" class="headerlink" title="8. 误预测更新状态机"></a>8. 误预测更新状态机</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs txt">┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                         误预测更新状态机                                         │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>输入信号:<br>  - update_mispredict: 分支误预测<br>  - tag_match: 标签是否匹配<br>  - ctr_match: 循环计数是否匹配 (p_cnt == update_meta.s_cnt)<br><br>状态转换表:<br><br>┌─────────────────┬───────────┬───────────┬─────────────────────────────────────────┐<br>│     当前状态     │ tag_match │ ctr_match │              操作                        │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf=7 (已学习) │    Yes    │     -     │ conf--, s_cnt=0 (降低置信度)             │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf=7 (已学习) │    No     │     -     │ 不操作 (保护高置信条目)                   │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf∈[1,6]     │    Yes    │    Yes    │ conf++, s_cnt=0 (增加置信度)             │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf∈[1,6]     │    Yes    │    No     │ conf=0, s_cnt=0, p_cnt=meta.s_cnt       │<br>│                 │           │           │ (循环次数改变，重新学习)                  │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf∈[1,6]     │    No     │     -     │ if age==0: 替换条目                      │<br>│                 │           │           │ else: age-- (老化)                       │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf=0 (未学习) │    Yes    │    Yes    │ conf=1, age=7, s_cnt=0 (开始学习)        │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf=0 (未学习) │    Yes    │    No     │ p_cnt=meta.s_cnt, age=7, s_cnt=0        │<br>│                 │           │           │ (更新预测计数)                           │<br>├─────────────────┼───────────┼───────────┼─────────────────────────────────────────┤<br>│ conf=0 (未学习) │    No     │     -     │ 分配新条目: tag, conf=1, age=7,         │<br>│                 │           │           │ s_cnt=0, p_cnt=meta.s_cnt               │<br>└─────────────────┴─────────���─┴─��─────────┴─────────────────────────────────────────┘<br><br><br>状态机可视化:<br><br>                              误预测事件<br>                                  │<br>                                  ▼<br>            ┌─────────────────────────────────────────────────┐<br>            │                 conf == 7?                      │<br>            └─────────────────────┬───────────────────────────┘<br>                    ┌─────────────┴─────────────┐<br>                    │                           │<br>                    ▼                           ▼<br>                conf = 7                    conf &lt; 7<br>                    │                           │<br>                    ▼                           ▼<br>            ┌─────────────┐           ┌─────────────────────┐<br>            │ tag_match?  │           │     conf == 0?      │<br>            └──────┬──────┘           └──────────┬──────────┘<br>               ┌───┴───┐                    ┌────┴────┐<br>               ▼       ▼                    ▼         ▼<br>             Yes      No                 conf=0    conf&gt;0<br>               │       │                    │         │<br>               ▼       ▼                    ▼         ▼<br>          ┌────────┐ ┌────────┐      ┌──────────┐ ┌────────────┐<br>          │conf--  │ │不操作  │      │tag_match?│ │ tag_match? │<br>          │s_cnt=0 │ │(保护)  │      └────┬─────┘ └─────┬──────┘<br>          └────────┘ └────────┘       ┌───┴───┐     ���───┴───┐<br>                                      ▼       ▼     ▼       ▼<br>                                    Yes      No   Yes      No<br>                                      │       │     │       │<br>                                      ▼       ▼     ▼       ▼<br>                                 ┌────────┐ ┌────┐ ┌───┐ ┌────────┐<br>                                 │ctr_match│ │分配│ │ctr│ │age==0?│<br>                                 └────┬───┘ │新条│ │匹配│ └───┬───┘<br>                                  ┌───┴───┐ │目  │ │?  │   ┌─┴──┐<br>                                  ▼       ▼ └────┘ └─┬─┘   ▼    ▼<br>                                Yes      No      ┌──┴──┐ 替换 age--<br>                                  │       │      ▼     ▼<br>                                  ▼       ▼    Yes    No<br>                            ┌────────┐ ┌────────┐│      │<br>                            │conf=1  │ │更新    ││      │<br>                            │age=7   │ │p_cnt   │▼      ▼<br>                            └────────┘ └────────┘conf++ 更新p_cnt<br><br></code></pre></td></tr></table></figure>
<h3 id="9-修复更新-Repair-Update"><a href="#9-修复更新-Repair-Update" class="headerlink" title="9. 修复更新 (Repair Update)"></a>9. 修复更新 (Repair Update)</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────���───────────────────────────────────────────────────────┐<br>│                         修复更新 (Repair)                                        │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>场景: 推测执行被取消，需要恢复 s_cnt 到正确状态<br><br>    误预测发生<br>         │<br>         ▼<br>    ┌─────────────────────────────────────────────────────────────┐<br>    │  is_repair_update = true                                   │<br>    │  update_meta.s_cnt = 正确的循环计数值                        │<br>    └─────────────────────────────────────────────────────────────┘<br>         │<br>         ▼<br>    ┌─────────────────────────────────────────────────────────────┐<br>    │  检查条件:                                                  │<br>    │  1. tag_match (确保是同一个循环)                            │<br>    │  2. !(f4_fire &amp;&amp; update_idx == f4_idx)                     │<br>    │     (避免与推测更新冲突)                                     │<br>    └─────────────────────────────────────────────────────────────┘<br>         │<br>         ▼<br>    ┌─────────────────────────────────────────────────────────────┐<br>    │  entries(update_idx).s_cnt := update_meta.s_cnt            │<br>    │  恢复到误预测前的计数值                                      │<br>    └─────────────────────────────────────────────────────────────┘<br><br><br>F2 阶段的旁路处理:<br><br>    当前读取的条目可能已经被修复/误预测更新影响<br>    需要实时旁路:<br><br>    f2_entry.s_cnt :=<br>        if (update_repair &amp;&amp; idx_match)      → update_meta.s_cnt<br>        elif (update_mispredict &amp;&amp; idx_match) → 0<br>        else                                  → entries(idx).s_cnt<br><br></code></pre></td></tr></table></figure>
<h3 id="10-年龄替换策略"><a href="#10-年龄替换策略" class="headerlink" title="10. 年龄替换策略"></a>10. 年龄替换策略</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                         年龄 (Age) 替换策略                                      │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>目的: 管理条目的生命周期，平衡新旧循环<br><br>年龄计数器行为:<br><br>    ┌────────────────────────────────────────────────────────────────────────────┐<br>    │                                                                             │<br>    │   增加 age (保护条目):                                                       │<br>    │   ├─ 每次成功预测使用: age = min(age + 1, 7)                                │<br>    │   ├─ 新分配条目: age = 7                                                   │<br>    │   └─ 循环结束重置: age = 7                                                  │<br>    │                                                                             │<br>    │   减少 age (老化):                                                          │<br>    │   └─ 误预测且标签不匹配: age = age - 1 (如果 age &gt; 0)                       │<br>    │                                                                             │<br>    │   替换条件:                                                                 │<br>    │   └─ conf ∈ [1,6] &amp;&amp; !tag_match &amp;&amp; age == 0                                │<br>    │                                                                             │<br>    └────────────────────────────────────────────────────────────────────────────┘<br><br>替换流程:<br><br>    新循环分支需要条目<br>           │<br>           ▼<br>    ┌─────────────────────────────────────┐<br>    │  检查目标位置的条目                  │<br>    │  entry = entries(hash(pc))          │<br>    └────────────��────┬───────────────────┘<br>                      │<br>                      ▼<br>    ┌─────────────────────────────────────┐<br>    │  conf == 7?                         │<br>    └─────────────────┬───────────────────┘<br>                      │<br>         ┌────────────┴────────────┐<br>         │                         │<br>         ▼                         ▼<br>    conf == 7                  conf &lt; 7<br>    (已完全学习)                (未完全学习)<br>         │                         │<br>         ▼                         ▼<br>    ┌─────────────┐        ┌─────────────────────┐<br>    │ 不替换!     │        │ age == 0?           │<br>    │ 保护高置信度│        └──────────┬──────────┘<br>    └─────────────┘                   │<br>                            ┌─────────┴───────��─┐<br>                            │                   │<br>                            ▼                   ▼<br>                        age == 0            age &gt; 0<br>                            │                   │<br>                            ▼                   ▼<br>                    ┌─────────────┐      ┌─────────────┐<br>                    │ 替换!       │      │ age--       │<br>                    │ 分配新条目  │      │ 下次可能替换│<br>                    └─────────────┘      └─────────────┘<br><br></code></pre></td></tr></table></figure>
<h3 id="11-完整数据流图"><a href="#11-完整数据流图" class="headerlink" title="11. 完整数据流图"></a>11. 完整数据流图</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌──────────────────────────────────────────────────────────────────────────────────────────┐<br>│                           Loop Predictor 完整数据流                                       │<br>└──────────────────────────────────────────────────────────────────────────────────────────┘<br><br>                              ┌─────────────────┐<br>                              │  取指请求        │<br>                              │  s2_idx         │<br>                              │  s2_valid       │<br>                              └────────┬────────┘<br>                                       │<br>                                       ▼<br>    ┌─────────────────────────────────────────────────────────────────────────────────────┐<br>    │                              F2: 条目读取                                            │<br>    │                                                                                      │<br>    │   ┌─��───────────────────────────────────────────────────────────────────────────┐   │<br>    │   │  对每个 Column (0..bankWidth-1):                                             │   │<br>    │   │                                                                              │   │<br>    │   │    f2_entry = entries(f2_req_idx)                                           │   │<br>    │   │                                                                              │   │<br>    │   │    旁路检查 (同一索引的更新):                                                  │   │<br>    │   │    if (update_repair &amp;&amp; idx_match):                                         │   │<br>    │   │        f2_entry.s_cnt = update_meta.s_cnt                                   │   │<br>    │   │    elif (update_mispredict &amp;&amp; idx_match):                                   │   │<br>    │   │        f2_entry.s_cnt = 0                                                   │   │<br>    │   └─────────────────────────────────────────────────────────────────────────────┘   │<br>    │                                                                                      │<br>    └───────────────────────────────────────────────┬──────────────────────────────────────┘<br>                                                    │ RegNext<br>                                                    ▼<br>    ┌─────────────────────────────────────────────────────────────────────────────────────┐<br>    │                              F3: 预测决策                                            │<br>    │                                                                                      │<br>    │   ┌─────────────────────────────────────────────────────────────────────────────┐   │<br>    │   │  f3_entry = RegNext(f2_entry)                                               │   │<br>    │   │  f3_tag = PC 高位标签                                                        │   │<br>    │   │  f3_scnt = s_cnt (可能被旁路更新)                                            │   │<br>    │   │                                                                              │   │<br>    │   │  io.f3_pred = io.f3_pred_in   // 默认透传                                   │   │<br>    │   │                                                                              │   │<br>    │   │  when (f3_entry.tag == f3_tag):                                             │   │<br>    │   │      when (f3_scnt == f3_entry.p_cnt &amp;&amp; f3_entry.conf == 7):                │   │<br>    │   │          io.f3_pred = !io.f3_pred_in   // 翻转预测!                          │   │<br>    │   │                                                                              │   │<br>    │   │  io.f3_meta.s_cnt = f3_scnt   // 保存用于恢复                                │   │<br>    │   └─────────────────────────────────────────────────────────────────────────────┘   │<br>    │                                                                                      │<br>    └───────────────────────────────────────────────┬──────────────────────────────────────┘<br>                                                    │ RegNext<br>                                                    ▼<br>    ┌─────────────────────────────────────────────────────────────────────────────────────┐<br>    │                              F4: 推测更新                                            │<br>    │                                                                                      │<br>    │   ┌─────────────────────────────────────────────────────────────────────────────┐   │<br>    │   │  when (f4_fire &amp;&amp; f4_entry.tag == f4_tag):                                  │   │<br>    │   │                                                                              │   │<br>    │   │      when (f4_scnt == f4_entry.p_cnt &amp;&amp; f4_entry.conf == 7):                │   │<br>    │   │          // 循环结束                                                         │   │<br>    │   │          entries(f4_idx).s_cnt = 0                                          │   │<br>    │   │          entries(f4_idx).age = 7                                            │   │<br>    │   │                                                                              │   │<br>    │   │      otherwise:                                                             │   │<br>    │   │          // 循环继续                                                         │   │<br>    │   │          entries(f4_idx).s_cnt = f4_scnt + 1                                │   │<br>    │   │          entries(f4_idx).age = min(f4_entry.age + 1, 7)                     │   │<br>    │   └─────────────────────────────────────────────────────────────────────────────┘   │<br>    │                                                                                      │<br>    └──────────────────────────────────────────────────────────────────────────────────────┘<br><br>                              ┌─────────────────┐<br>                              │  更新路径        │<br>                              │  s1_update      │<br>                              └────────┬────────┘<br>                                       │<br>    ┌──────────────────────────────────┴───────────────────────────────────────────────────┐<br>    │                                                                                       │<br>    │   ┌────────────────────────────────┐      ┌────────────────────────────────┐         │<br>    │   │     update_mispredict          │      │       update_repair            │         │<br>    │   │     (误预测更新)                │      │       (修复更新)               │         │<br>    │   └───────────────┬────────────────┘      └───────────────┬────────────────┘         │<br>    │                   │                                       │                          │<br>    │                   ▼                                       ▼                          │<br>    │   ┌────────────────────────────────────────────────────────────────────────────┐    │<br>    │   │                                                                             │    │<br>    │   │  误预测: 根据 conf, tag_match, ctr_match 执行状态机                         │    │<br>    │   │          更新 conf, age, p_cnt, s_cnt, tag                                 │    │<br>    │   │                                                                             │    │<br>    │   │  修复: 仅恢复 s_cnt = update_meta.s_cnt                                     │    │<br>    │   │        (如果 tag_match 且无 F4 冲突)                                        │    │<br>    │   │                                                                             │    │<br>    │   └────────────────────────────────────────────────────────────────────────────┘    │<br>    │                                                                                       │<br>    └───────────────────────────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>
<h3 id="12-Loop-Predictor-与其他预测器的协作"><a href="#12-Loop-Predictor-与其他预测器的协作" class="headerlink" title="12. Loop Predictor 与其他预测器的协作"></a>12. Loop Predictor 与其他预测器的协作</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                    Loop Predictor 在预测器层次中的位置                           │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br><br>                              ┌─────────────────┐<br>                              │    取指 PC       │<br>                              └────────┬────────┘<br>                                       │<br>                    ┌──────────────────┴──────────────────┐<br>                    │                                     │<br>                    ▼                                     ▼<br>            ┌───────────────┐                     ┌───────────────┐<br>            │     BTB       │                     │   BIM/TAGE    │<br>            │ (��标地址)    │                     │ (方向预测)    │<br>            └───────┬───────┘                     └───────┬───────┘<br>                    │                                     │<br>                    │                                     ▼<br>                    │                             ┌───────────────┐<br>                    │                             │    Loop       │<br>                    │                             │  Predictor    │<br>                    │                             │ (循环覆盖)    │<br>                    │                             └───────┬───────┘<br>                    │                                     │<br>                    │                                     │<br>                    └──────────────────┬──────────────────┘<br>                                       │<br>                                       ▼<br>                              ┌───────────────────┐<br>                              │   最终预测结果     │<br>                              │                   │<br>                              │ target = BTB      │<br>                              │ taken = Loop或BIM │<br>                              └───────────────────┘<br><br>数据流:<br><br>    io.resp_in(0)          io.resp<br>         │                    │<br>         │  ┌─────────────┐   │<br>         └─►│    Loop     │───┘<br>            │  Predictor  │<br>            └─────────────┘<br><br>    Loop 接收基础预测 (f3_pred_in)<br>    条件满足时翻转输出 (f3_pred)<br>    否则透传基础预测<br></code></pre></td></tr></table></figure>
<p>优势:</p>
<ul>
<li>BIM&#x2F;TAGE 善于预测通用分支模式</li>
<li>Loop Predictor 专门处理循环退出</li>
<li>两者互补，提高整体预测精度</li>
</ul>
<h3 id="13-关键参数总结"><a href="#13-关键参数总结" class="headerlink" title="13. 关键参数总结"></a>13. 关键参数总结</h3><table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>nSets</td>
<td>16</td>
<td>每列条目数</td>
</tr>
<tr>
<td>tagSz</td>
<td>10</td>
<td>标签位宽</td>
</tr>
<tr>
<td>nWays</td>
<td>4</td>
<td>(参数中定义但未使用)</td>
</tr>
<tr>
<td>threshold</td>
<td>7</td>
<td>(参数中定义但未使用)</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>LoopEntry 字段</th>
<th>位宽</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>tag</td>
<td>10</td>
<td>地址标签</td>
</tr>
<tr>
<td>conf</td>
<td>3</td>
<td>置信度 (0-7)</td>
</tr>
<tr>
<td>age</td>
<td>3</td>
<td>年龄计数器 (0-7)</td>
</tr>
<tr>
<td>p_cnt</td>
<td>10</td>
<td>预测循环次数 (0-1023)</td>
</tr>
<tr>
<td>s_cnt</td>
<td>10</td>
<td>当前迭代次数 (0-1023)</td>
</tr>
</tbody></table>
<h3 id="14-设计特点总结"><a href="#14-设计特点总结" class="headerlink" title="14. 设计特点总结"></a>14. 设计特点总结</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt"><br>┌─────────────────────────────────────────────────────────────────────────────────┐<br>│                         Loop Predictor 设计特点                                  │<br>└─────────────────────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<ol>
<li><p>专用性:</p>
<ul>
<li>专门针对循环分支设计</li>
<li>不试图预测所有分支，只处理学习到的稳定循环</li>
</ul>
</li>
<li><p>保守性:</p>
<ul>
<li>只有 conf&#x3D;7 时才覆盖基础预测</li>
<li>需要多次正确观察才能建立置信度</li>
<li>减少错误覆盖导致的性能损失</li>
</ul>
</li>
<li><p>推测执行支持:</p>
<ul>
<li>s_cnt 在预测使用后推测更新 (F4)</li>
<li>支持 repair 恢复误预测路径上的状态</li>
<li>旁路机制确保最新数据可见</li>
</ul>
</li>
<li><p>老化与替换:</p>
<ul>
<li>age 计数器防止有用条目被快速替换</li>
<li>高置信度条目 (conf&#x3D;7) 受到保护</li>
<li>未活跃条目逐渐老化可被替换</li>
</ul>
</li>
<li><p>资源效率:</p>
<ul>
<li>使用寄存器而非 SRAM (小规模 16 条目)</li>
<li>每个 bank 独立的 Column，避免冲突</li>
<li>简单的标签匹配，无复杂的多路选择</li>
</ul>
</li>
</ol>
<p>Loop Predictor 是一种专用预测器，专门用于处理循环分支的退出预测问题。它通过学习循环的精确迭代次数，在循环即将结束时覆盖基础预测器的预测，从而显著提高循环密集型代码的分支预测精度。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" class="category-chain-item">计算机体系结构</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/" class="print-no-link">#分支预测</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>riscv-boom&#39;s loop</div>
      <div>http://blog.luliang.online/2025/12/02/分支预测器loop/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Luyoung</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/02/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A8boom/" title="riscv-boom&#39;s bp">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">riscv-boom&#39;s bp</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/12/02/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B%E5%99%A8tage/" title="riscv-boom&#39;s tage">
                        <span class="hidden-mobile">riscv-boom&#39;s tage</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
